diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/I3_VERSION ./I3_VERSION
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/I3_VERSION	2015-04-16 02:03:09.000000000 -0500
+++ ./I3_VERSION	2015-06-20 00:55:40.000000000 -0500
@@ -1 +1 @@
-4.10.2 (2015-04-16, branch \"4.10.2\")
\ No newline at end of file
+4.10.2-346-g8c0594a (2015-05-03, branch \"gaps\")
\ No newline at end of file
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/Makefile ./Makefile
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/Makefile	2015-04-16 02:03:02.000000000 -0500
+++ ./Makefile	2015-06-20 00:55:28.000000000 -0500
@@ -22,6 +22,12 @@
 include docs/docs.mk
 include man/man.mk
 
+# Update $(TOPDIR)/LAST_VERSION if it differs from $I3_VERSION
+CACHED_VERSION := '$(shell [ -f $(TOPDIR)/LAST_VERSION ] && cat $(TOPDIR)/LAST_VERSION)'
+ifneq ($(CACHED_VERSION),$(I3_VERSION))
+$(shell echo -n ${I3_VERSION} > $(TOPDIR)/LAST_VERSION)
+endif
+
 real-all: $(ALL_TARGETS)
 
 install: $(INSTALL_TARGETS)
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/common.mk ./common.mk
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/common.mk	2015-04-16 02:03:02.000000000 -0500
+++ ./common.mk	2015-06-20 00:55:28.000000000 -0500
@@ -1,6 +1,5 @@
 UNAME=$(shell uname)
 DEBUG=1
-COVERAGE=0
 INSTALL=install
 LN=ln
 ifndef PREFIX
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/docs/debugging.html ./docs/debugging.html
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/docs/debugging.html	2015-04-16 02:03:09.000000000 -0500
+++ ./docs/debugging.html	2015-06-20 00:55:40.000000000 -0500
@@ -3,7 +3,7 @@
 <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
 <head>
 <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
-<meta name="generator" content="AsciiDoc 8.6.8" />
+<meta name="generator" content="AsciiDoc 8.6.9" />
 <title>Debugging i3: How To</title>
 <style type="text/css">
 /* Shared CSS for AsciiDoc xhtml11 and html5 backends */
@@ -94,7 +94,9 @@
   padding: 0;
   margin: 0;
 }
-
+pre {
+  white-space: pre-wrap;
+}
 
 #author {
   color: #527bbd;
@@ -223,7 +225,7 @@
 }
 
 div.imageblock div.content { padding-left: 0; }
-span.image img { border-style: none; }
+span.image img { border-style: none; vertical-align: text-bottom; }
 a.image:visited { color: white; }
 
 dl {
@@ -872,7 +874,7 @@
 <div id="footnotes"><hr /></div>
 <div id="footer">
 <div id="footer-text">
-Last updated 2015-04-16 09:02:58 CEST
+Last updated 2015-06-19 23:47:23 CDT
 </div>
 </div>
 </body>
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/docs/hacking-howto ./docs/hacking-howto
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/docs/hacking-howto	2015-04-16 02:03:09.000000000 -0500
+++ ./docs/hacking-howto	2015-06-20 00:55:40.000000000 -0500
@@ -404,10 +404,14 @@
 
 == _NET_WM_STATE
 
-Only the _NET_WM_STATE_FULLSCREEN atom is handled. It calls
-``toggle_fullscreen()'' for the specific client which just configures the
-client to use the whole screen on which it currently is. Also, it is set as
-fullscreen_client for the i3Screen.
+Only the _NET_WM_STATE_FULLSCREEN and _NET_WM_STATE_DEMANDS_ATTENTION atoms
+are handled.
+
+The former calls ``toggle_fullscreen()'' for the specific client which just
+configures the client to use the whole screen on which it currently is.
+Also, it is set as fullscreen_client for the i3Screen.
+
+The latter is used to set, read and display urgency hints.
 
 == WM_NAME
 
@@ -629,8 +633,8 @@
 +x_draw_decoration+ draws window decorations. It is run for every leaf
 container (representing an actual X11 window) and for every non-leaf container
 which is in a stacked/tabbed container (because stacked/tabbed containers
-display a window decoration for split containers, which at the moment just says
-"another container").
+display a window decoration for split containers, which consists of a representation
+of the child container's names.
 
 Then, parameters are collected to be able to determine whether this decoration
 drawing is actually necessary or was already done. This saves a substantial
@@ -686,9 +690,9 @@
 In earlier versions of i3, interpreting these commands was done using lex and
 yacc, but experience has shown that lex and yacc are not well suited for our
 command language. Therefore, starting from version 4.2, we use a custom parser
-for user commands (not yet for the configuration file).
+for user commands and the configuration file.
 The input specification for this parser can be found in the file
-+parser-specs/commands.spec+. Should you happen to use Vim as an editor, use
++parser-specs/*.spec+. Should you happen to use Vim as an editor, use
 :source parser-specs/highlighting.vim to get syntax highlighting for this file
 (highlighting files for other editors are welcome).
 
@@ -729,11 +733,14 @@
 # workspace next|prev|next_on_output|prev_on_output
 # workspace back_and_forth
 # workspace <name>
+# workspace number <number>
 state WORKSPACE:
   direction = 'next_on_output', 'prev_on_output', 'next', 'prev'
       -> call cmd_workspace($direction)
   'back_and_forth'
       -> call cmd_workspace_back_and_forth()
+  'number'
+      -> WORKSPACE_NUMBER
   workspace = string
       -> call cmd_workspace_name($workspace)
 ----------------------------------------------------------------
@@ -772,6 +779,10 @@
 	single quotes), but just called string. Other possible tokens are word
 	(the same as string, but stops matching at a whitespace) and end
 	(matches the end of the input).
+workspace number <number>::
+        The workspace command has to be followed by the keyword +number+. It
+        then transitions into the state +WORKSPACE_NUMBER+, where the actual
+        parameter will be read.
 
 === Introducing a new command
 
@@ -952,18 +963,21 @@
 or, for more documentation, see http://git-scm.com/documentation
 
 Please talk to us before working on new features to see whether they will be
-accepted. There are a few things which we don’t want to see in i3, e.g. a
-command which will focus windows in an alt+tab like way.
+accepted. A good way for this is to open an issue and asking for opinions on it.
+Even for accepted features, this can be a good way to refine an idea upfront. However,
+we don't want to see certain features in i3, e.g., switching window focus in an
+Alt+Tab like way.
 
 When working on bugfixes, please make sure you mention that you are working on
-it in the corresponding bugreport at https://github.com/i3/i3/issues In case
-there is no bugreport yet, please create one.
+it in the corresponding bug report at https://github.com/i3/i3/issues. In case
+there is no bug report yet, please create one.
 
-After you are done, please submit your work for review at https://github.com/i3/i3
+After you are done, please submit your work for review as a pull request at
+https://github.com/i3/i3.
 
 Do not send emails to the mailing list or any author directly, and don’t submit
 them in the bugtracker, since all reviews should be done in public at
-http://cr.i3wm.org/. In order to make your review go as fast as possible, you
+https://github.com/i3/i3. In order to make your review go as fast as possible, you
 could have a look at previous reviews and see what the common mistakes are.
 
 === Which branch to use?
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/docs/hacking-howto.html ./docs/hacking-howto.html
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/docs/hacking-howto.html	2015-04-16 02:03:09.000000000 -0500
+++ ./docs/hacking-howto.html	2015-06-20 00:55:40.000000000 -0500
@@ -3,7 +3,7 @@
 <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
 <head>
 <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
-<meta name="generator" content="AsciiDoc 8.6.8" />
+<meta name="generator" content="AsciiDoc 8.6.9" />
 <title>Hacking i3: How To</title>
 <style type="text/css">
 /* Shared CSS for AsciiDoc xhtml11 and html5 backends */
@@ -94,7 +94,9 @@
   padding: 0;
   margin: 0;
 }
-
+pre {
+  white-space: pre-wrap;
+}
 
 #author {
   color: #527bbd;
@@ -223,7 +225,7 @@
 }
 
 div.imageblock div.content { padding-left: 0; }
-span.image img { border-style: none; }
+span.image img { border-style: none; vertical-align: text-bottom; }
 a.image:visited { color: white; }
 
 dl {
@@ -1424,10 +1426,12 @@
 <div class="sect1">
 <h2 id="_net_wm_state">10. _NET_WM_STATE</h2>
 <div class="sectionbody">
-<div class="paragraph"><p>Only the _NET_WM_STATE_FULLSCREEN atom is handled. It calls
-&#8220;toggle_fullscreen()&#8221; for the specific client which just configures the
-client to use the whole screen on which it currently is. Also, it is set as
-fullscreen_client for the i3Screen.</p></div>
+<div class="paragraph"><p>Only the _NET_WM_STATE_FULLSCREEN and _NET_WM_STATE_DEMANDS_ATTENTION atoms
+are handled.</p></div>
+<div class="paragraph"><p>The former calls &#8220;toggle_fullscreen()&#8221; for the specific client which just
+configures the client to use the whole screen on which it currently is.
+Also, it is set as fullscreen_client for the i3Screen.</p></div>
+<div class="paragraph"><p>The latter is used to set, read and display urgency hints.</p></div>
 </div>
 </div>
 <div class="sect1">
@@ -1755,8 +1759,8 @@
 <div class="paragraph"><p><code>x_draw_decoration</code> draws window decorations. It is run for every leaf
 container (representing an actual X11 window) and for every non-leaf container
 which is in a stacked/tabbed container (because stacked/tabbed containers
-display a window decoration for split containers, which at the moment just says
-"another container").</p></div>
+display a window decoration for split containers, which consists of a representation
+of the child container&#8217;s names.</p></div>
 <div class="paragraph"><p>Then, parameters are collected to be able to determine whether this decoration
 drawing is actually necessary or was already done. This saves a substantial
 number of redraws (depending on your workload, but far over 50%).</p></div>
@@ -1781,9 +1785,9 @@
 <div class="paragraph"><p>In earlier versions of i3, interpreting these commands was done using lex and
 yacc, but experience has shown that lex and yacc are not well suited for our
 command language. Therefore, starting from version 4.2, we use a custom parser
-for user commands (not yet for the configuration file).
+for user commands and the configuration file.
 The input specification for this parser can be found in the file
-<code>parser-specs/commands.spec</code>. Should you happen to use Vim as an editor, use
+<code>parser-specs/*.spec</code>. Should you happen to use Vim as an editor, use
 :source parser-specs/highlighting.vim to get syntax highlighting for this file
 (highlighting files for other editors are welcome).</p></div>
 <div class="listingblock">
@@ -1821,11 +1825,14 @@
 <pre><code># workspace next|prev|next_on_output|prev_on_output
 # workspace back_and_forth
 # workspace &lt;name&gt;
+# workspace number &lt;number&gt;
 state WORKSPACE:
   direction = 'next_on_output', 'prev_on_output', 'next', 'prev'
       -&gt; call cmd_workspace($direction)
   'back_and_forth'
       -&gt; call cmd_workspace_back_and_forth()
+  'number'
+      -&gt; WORKSPACE_NUMBER
   workspace = string
       -&gt; call cmd_workspace_name($workspace)</code></pre>
 </div></div>
@@ -1894,6 +1901,16 @@
         (matches the end of the input).
 </p>
 </dd>
+<dt class="hdlist1">
+workspace number &lt;number&gt;
+</dt>
+<dd>
+<p>
+        The workspace command has to be followed by the keyword <code>number</code>. It
+        then transitions into the state <code>WORKSPACE_NUMBER</code>, where the actual
+        parameter will be read.
+</p>
+</dd>
 </dl></div>
 </div>
 <div class="sect2">
@@ -2192,15 +2209,18 @@
 <a href="http://web.archive.org/web/20121024222556/http://www.spheredev.org/wiki/Git_for_the_lazy">http://web.archive.org/web/20121024222556/http://www.spheredev.org/wiki/Git_for_the_lazy</a>
 or, for more documentation, see <a href="http://git-scm.com/documentation">http://git-scm.com/documentation</a></p></div>
 <div class="paragraph"><p>Please talk to us before working on new features to see whether they will be
-accepted. There are a few things which we don’t want to see in i3, e.g. a
-command which will focus windows in an alt+tab like way.</p></div>
+accepted. A good way for this is to open an issue and asking for opinions on it.
+Even for accepted features, this can be a good way to refine an idea upfront. However,
+we don&#8217;t want to see certain features in i3, e.g., switching window focus in an
+Alt+Tab like way.</p></div>
 <div class="paragraph"><p>When working on bugfixes, please make sure you mention that you are working on
-it in the corresponding bugreport at <a href="https://github.com/i3/i3/issues">https://github.com/i3/i3/issues</a> In case
-there is no bugreport yet, please create one.</p></div>
-<div class="paragraph"><p>After you are done, please submit your work for review at <a href="https://github.com/i3/i3">https://github.com/i3/i3</a></p></div>
+it in the corresponding bug report at <a href="https://github.com/i3/i3/issues">https://github.com/i3/i3/issues</a>. In case
+there is no bug report yet, please create one.</p></div>
+<div class="paragraph"><p>After you are done, please submit your work for review as a pull request at
+<a href="https://github.com/i3/i3">https://github.com/i3/i3</a>.</p></div>
 <div class="paragraph"><p>Do not send emails to the mailing list or any author directly, and don’t submit
 them in the bugtracker, since all reviews should be done in public at
-<a href="http://cr.i3wm.org/">http://cr.i3wm.org/</a>. In order to make your review go as fast as possible, you
+<a href="https://github.com/i3/i3">https://github.com/i3/i3</a>. In order to make your review go as fast as possible, you
 could have a look at previous reviews and see what the common mistakes are.</p></div>
 </div>
 <div class="sect2">
@@ -2298,7 +2318,7 @@
 <div id="footnotes"><hr /></div>
 <div id="footer">
 <div id="footer-text">
-Last updated 2015-04-16 09:02:58 CEST
+Last updated 2015-06-19 23:47:23 CDT
 </div>
 </div>
 </body>
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/docs/i3bar-protocol ./docs/i3bar-protocol
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/docs/i3bar-protocol	2015-04-16 02:03:09.000000000 -0500
+++ ./docs/i3bar-protocol	2015-06-20 00:55:40.000000000 -0500
@@ -136,6 +136,20 @@
 	when it is associated.
 	Colors are specified in hex (like in HTML), starting with a leading
 	hash sign. For example, +#ff0000+ means red.
+background::
+        Sets the background color of the block. If not given, this defaults to
+        the i3bar background.
+border::
+        Sets the border color of the block. If not given, this defaults to the
+        i3bar background.
+border_top::
+        Width of the top border. The default is 1.
+border_bottom::
+        Width of the bottom border. The default is 1.
+border_left::
+        Width of the left border. The default is 1.
+border_right::
+        Width of the right border. The default is 1.
 min_width::
 	The minimum width (in pixels) of the block. If the content of the
 	+full_text+ key take less space than the specified min_width, the block
@@ -207,6 +221,12 @@
  "full_text": "E: 10.0.0.1 (1000 Mbit/s)",
  "short_text": "10.0.0.1",
  "color": "#00ff00",
+ "background": "#000000",
+ "border": "#ffffff",
+ "border_top": 1,
+ "border_bottom": 0,
+ "border_left": 2,
+ "border_right": 2,
  "min_width": 300,
  "align": "right",
  "urgent": false,
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/docs/i3bar-protocol.html ./docs/i3bar-protocol.html
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/docs/i3bar-protocol.html	2015-04-16 02:03:09.000000000 -0500
+++ ./docs/i3bar-protocol.html	2015-06-20 00:55:40.000000000 -0500
@@ -3,7 +3,7 @@
 <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
 <head>
 <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
-<meta name="generator" content="AsciiDoc 8.6.8" />
+<meta name="generator" content="AsciiDoc 8.6.9" />
 <title>i3bar input protocol</title>
 <style type="text/css">
 /* Shared CSS for AsciiDoc xhtml11 and html5 backends */
@@ -94,7 +94,9 @@
   padding: 0;
   margin: 0;
 }
-
+pre {
+  white-space: pre-wrap;
+}
 
 #author {
   color: #527bbd;
@@ -223,7 +225,7 @@
 }
 
 div.imageblock div.content { padding-left: 0; }
-span.image img { border-style: none; }
+span.image img { border-style: none; vertical-align: text-bottom; }
 a.image:visited { color: white; }
 
 dl {
@@ -937,6 +939,56 @@
 </p>
 </dd>
 <dt class="hdlist1">
+background
+</dt>
+<dd>
+<p>
+        Sets the background color of the block. If not given, this defaults to
+        the i3bar background.
+</p>
+</dd>
+<dt class="hdlist1">
+border
+</dt>
+<dd>
+<p>
+        Sets the border color of the block. If not given, this defaults to the
+        i3bar background.
+</p>
+</dd>
+<dt class="hdlist1">
+border_top
+</dt>
+<dd>
+<p>
+        Width of the top border. The default is 1.
+</p>
+</dd>
+<dt class="hdlist1">
+border_bottom
+</dt>
+<dd>
+<p>
+        Width of the bottom border. The default is 1.
+</p>
+</dd>
+<dt class="hdlist1">
+border_left
+</dt>
+<dd>
+<p>
+        Width of the left border. The default is 1.
+</p>
+</dd>
+<dt class="hdlist1">
+border_right
+</dt>
+<dd>
+<p>
+        Width of the right border. The default is 1.
+</p>
+</dd>
+<dt class="hdlist1">
 min_width
 </dt>
 <dd>
@@ -1047,6 +1099,12 @@
  "full_text": "E: 10.0.0.1 (1000 Mbit/s)",
  "short_text": "10.0.0.1",
  "color": "#00ff00",
+ "background": "#000000",
+ "border": "#ffffff",
+ "border_top": 1,
+ "border_bottom": 0,
+ "border_left": 2,
+ "border_right": 2,
  "min_width": 300,
  "align": "right",
  "urgent": false,
@@ -1113,7 +1171,7 @@
 <div id="footnotes"><hr /></div>
 <div id="footer">
 <div id="footer-text">
-Last updated 2015-04-16 09:02:58 CEST
+Last updated 2015-06-19 23:47:23 CDT
 </div>
 </div>
 </body>
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/docs/ipc.html ./docs/ipc.html
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/docs/ipc.html	2015-04-16 02:03:09.000000000 -0500
+++ ./docs/ipc.html	2015-06-20 00:55:40.000000000 -0500
@@ -3,7 +3,7 @@
 <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
 <head>
 <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
-<meta name="generator" content="AsciiDoc 8.6.8" />
+<meta name="generator" content="AsciiDoc 8.6.9" />
 <title>IPC interface (interprocess communication)</title>
 <style type="text/css">
 /* Shared CSS for AsciiDoc xhtml11 and html5 backends */
@@ -94,7 +94,9 @@
   padding: 0;
   margin: 0;
 }
-
+pre {
+  white-space: pre-wrap;
+}
 
 #author {
   color: #527bbd;
@@ -223,7 +225,7 @@
 }
 
 div.imageblock div.content { padding-left: 0; }
-span.image img { border-style: none; }
+span.image img { border-style: none; vertical-align: text-bottom; }
 a.image:visited { color: white; }
 
 dl {
@@ -2187,7 +2189,7 @@
 <div id="footnotes"><hr /></div>
 <div id="footer">
 <div id="footer-text">
-Last updated 2015-04-16 09:02:58 CEST
+Last updated 2015-06-19 23:47:23 CDT
 </div>
 </div>
 </body>
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/docs/layout-saving.html ./docs/layout-saving.html
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/docs/layout-saving.html	2015-04-16 02:03:09.000000000 -0500
+++ ./docs/layout-saving.html	2015-06-20 00:55:40.000000000 -0500
@@ -3,7 +3,7 @@
 <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
 <head>
 <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
-<meta name="generator" content="AsciiDoc 8.6.8" />
+<meta name="generator" content="AsciiDoc 8.6.9" />
 <title>Layout saving in i3</title>
 <style type="text/css">
 /* Shared CSS for AsciiDoc xhtml11 and html5 backends */
@@ -94,7 +94,9 @@
   padding: 0;
   margin: 0;
 }
-
+pre {
+  white-space: pre-wrap;
+}
 
 #author {
   color: #527bbd;
@@ -223,7 +225,7 @@
 }
 
 div.imageblock div.content { padding-left: 0; }
-span.image img { border-style: none; }
+span.image img { border-style: none; vertical-align: text-bottom; }
 a.image:visited { color: white; }
 
 dl {
@@ -1010,7 +1012,7 @@
 <div id="footnotes"><hr /></div>
 <div id="footer">
 <div id="footer-text">
-Last updated 2015-04-16 09:02:58 CEST
+Last updated 2015-06-19 23:47:23 CDT
 </div>
 </div>
 </body>
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/docs/lib-i3test.html ./docs/lib-i3test.html
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/docs/lib-i3test.html	2015-04-16 02:03:09.000000000 -0500
+++ ./docs/lib-i3test.html	2015-06-20 00:55:40.000000000 -0500
@@ -328,7 +328,7 @@
 name="cmd($command)"
 >cmd($command)</a></h2>
 
-<p>Sends the specified command to i3.</p>
+<p>Sends the specified command to i3 and returns the output.</p>
 <pre><tt>  my $ws = unused_workspace;
   cmd &#34;workspace $ws&#34;;
   cmd &#39;focus right&#39;;</tt></pre>
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/docs/multi-monitor.html ./docs/multi-monitor.html
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/docs/multi-monitor.html	2015-04-16 02:03:09.000000000 -0500
+++ ./docs/multi-monitor.html	2015-06-20 00:55:40.000000000 -0500
@@ -3,7 +3,7 @@
 <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
 <head>
 <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
-<meta name="generator" content="AsciiDoc 8.6.8" />
+<meta name="generator" content="AsciiDoc 8.6.9" />
 <title>The multi-monitor situation</title>
 <style type="text/css">
 /* Shared CSS for AsciiDoc xhtml11 and html5 backends */
@@ -94,7 +94,9 @@
   padding: 0;
   margin: 0;
 }
-
+pre {
+  white-space: pre-wrap;
+}
 
 #author {
   color: #527bbd;
@@ -223,7 +225,7 @@
 }
 
 div.imageblock div.content { padding-left: 0; }
-span.image img { border-style: none; }
+span.image img { border-style: none; vertical-align: text-bottom; }
 a.image:visited { color: white; }
 
 dl {
@@ -812,7 +814,7 @@
 <div id="footnotes"><hr /></div>
 <div id="footer">
 <div id="footer-text">
-Last updated 2015-04-16 09:02:58 CEST
+Last updated 2015-06-19 23:47:23 CDT
 </div>
 </div>
 </body>
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/docs/testsuite ./docs/testsuite
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/docs/testsuite	2015-04-16 02:03:09.000000000 -0500
+++ ./docs/testsuite	2015-06-20 00:55:40.000000000 -0500
@@ -160,6 +160,27 @@
 This will show the output of Xephyr, which is the X server implementation we
 use for testing.
 
+==== Coverage testing
+
+Coverage testing is possible with +lcov+, the front-end for GCC's coverage
+testing tool +gcov+. The testcases can generate a nice html report that tells
+you which functions and lines were covered during a run of the tests. You can
+use this tool to judge how effective your tests are.
+
+To use test coverage tools, first compile with coverage enabled.
+
+---------------------------------------------------
+COVERAGE=1 make
+---------------------------------------------------
+
+Then run the tests with the +--coverage-testing+ flag.
+
+---------------------------------------------------
+./complete-run.pl --coverage-testing
+---------------------------------------------------
+
+Then open +latest/i3-coverage/index.html+ in your web browser.
+
 ==== IPC interface
 
 The testsuite makes extensive use of the IPC (Inter-Process Communication)
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/docs/testsuite.html ./docs/testsuite.html
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/docs/testsuite.html	2015-04-16 02:03:09.000000000 -0500
+++ ./docs/testsuite.html	2015-06-20 00:55:40.000000000 -0500
@@ -3,7 +3,7 @@
 <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
 <head>
 <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
-<meta name="generator" content="AsciiDoc 8.6.8" />
+<meta name="generator" content="AsciiDoc 8.6.9" />
 <title>i3 testsuite</title>
 <style type="text/css">
 /* Shared CSS for AsciiDoc xhtml11 and html5 backends */
@@ -94,7 +94,9 @@
   padding: 0;
   margin: 0;
 }
-
+pre {
+  white-space: pre-wrap;
+}
 
 #author {
   color: #527bbd;
@@ -223,7 +225,7 @@
 }
 
 div.imageblock div.content { padding-left: 0; }
-span.image img { border-style: none; }
+span.image img { border-style: none; vertical-align: text-bottom; }
 a.image:visited { color: white; }
 
 dl {
@@ -924,7 +926,25 @@
 use for testing.</p></div>
 </div>
 <div class="sect3">
-<h4 id="_ipc_interface">3.2.2. IPC interface</h4>
+<h4 id="_coverage_testing">3.2.2. Coverage testing</h4>
+<div class="paragraph"><p>Coverage testing is possible with <code>lcov</code>, the front-end for GCC&#8217;s coverage
+testing tool <code>gcov</code>. The testcases can generate a nice html report that tells
+you which functions and lines were covered during a run of the tests. You can
+use this tool to judge how effective your tests are.</p></div>
+<div class="paragraph"><p>To use test coverage tools, first compile with coverage enabled.</p></div>
+<div class="listingblock">
+<div class="content">
+<pre><code>COVERAGE=1 make</code></pre>
+</div></div>
+<div class="paragraph"><p>Then run the tests with the <code>--coverage-testing</code> flag.</p></div>
+<div class="listingblock">
+<div class="content">
+<pre><code>./complete-run.pl --coverage-testing</code></pre>
+</div></div>
+<div class="paragraph"><p>Then open <code>latest/i3-coverage/index.html</code> in your web browser.</p></div>
+</div>
+<div class="sect3">
+<h4 id="_ipc_interface">3.2.3. IPC interface</h4>
 <div class="paragraph"><p>The testsuite makes extensive use of the IPC (Inter-Process Communication)
 interface which i3 provides. It is used for the startup process of i3, for
 terminating it cleanly and (most importantly) for modifying and getting the
@@ -932,7 +952,7 @@
 <div class="paragraph"><p>See [<a href="http://i3wm.org/docs/ipc.html">http://i3wm.org/docs/ipc.html</a>] for documentation on the IPC interface.</p></div>
 </div>
 <div class="sect3">
-<h4 id="_x11_xcb">3.2.3. X11::XCB</h4>
+<h4 id="_x11_xcb">3.2.4. X11::XCB</h4>
 <div class="paragraph"><p>In order to open new windows, change attributes, get events, etc., the
 testsuite uses X11::XCB, a new (and quite specific to i3 at the moment) Perl
 module which uses the XCB protocol description to generate Perl bindings to
@@ -1361,7 +1381,7 @@
 <div id="footnotes"><hr /></div>
 <div id="footer">
 <div id="footer-text">
-Last updated 2015-04-16 09:02:58 CEST
+Last updated 2015-06-19 23:47:23 CDT
 </div>
 </div>
 </body>
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/docs/userguide ./docs/userguide
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/docs/userguide	2015-04-16 02:03:09.000000000 -0500
+++ ./docs/userguide	2015-06-20 00:55:40.000000000 -0500
@@ -256,8 +256,9 @@
 you moved down is directly attached to the workspace and appears on the bottom
 of the screen. A new (horizontal) container was created to accommodate the
 other two terminal windows. You will notice this when switching to tabbed mode
-(for example). You would end up having one tab called "another container" and
-the other one being the terminal window you moved down.
+(for example). You would end up having one tab with a representation of the split
+container (e.g., "H[urxvt firefox]") and the other one being the terminal window
+you moved down.
 
 [[configuring]]
 == Configuring i3
@@ -589,6 +590,27 @@
 
 The valid criteria are the same as those for commands, see <<command_criteria>>.
 
+=== Don't focus window upon opening
+
+[[no_focus]]
+
+When a new window appears, it will be focused. The +no_focus+ directive allows preventing
+this from happening and can be used in combination with <<command_criteria>>.
+
+Note that this does not apply to all cases, e.g., when feeding data into a running application
+causing it to request being focused. To configure the behavior in such cases, refer to
+<<focus_on_window_activation>>.
+
+*Syntax*:
+-------------------
+no_focus <criteria>
+-------------------
+
+*Example*:
+-------------------------------
+no_focus [window_role="pop-up"]
+-------------------------------
+
 === Variables
 
 As you learned in the section about keyboard bindings, you will have
@@ -981,6 +1003,51 @@
 force_display_urgency_hint 500 ms
 ---------------------------------
 
+=== Focus on window activation
+
+[[focus_on_window_activation]]
+
+If a window is activated, e.g., via +google-chrome www.google.com+, it may request
+to take focus. Since this may not preferable, different reactions can be configured.
+
+Note that this may not affect windows that are being opened. To prevent new windows
+from being focused, see <<no_focus>>.
+
+*Syntax*:
+----------------------------------------------------
+focus_on_window_activation <smart|urgent|focus|none>
+----------------------------------------------------
+
+The different modes will act as follows:
+
+smart::
+    This is the default behavior. If the window requesting focus is on an active
+    workspace, it will receive the focus. Otherwise, the urgency hint will be set.
+urgent::
+    The window will always be marked urgent, but the focus will not be stolen.
+focus::
+    The window will always be focused and not be marked urgent.
+none::
+    The window will neither be focused, nor be marked urgent.
+
+=== Drawing marks on window decoration
+
+If activated, marks on windows are drawn in their window decoration. However,
+any mark starting with an underscore in its name (+_+) will not be drawn even if
+this option is activated.
+
+The default for this option is +yes+.
+
+*Syntax*:
+-------------------
+show_marks [yes|no]
+-------------------
+
+*Example*:
+--------------
+show_marks yes
+--------------
+
 == Configuring i3bar
 
 The bar at the bottom of your monitor is drawn by a separate process called
@@ -1331,6 +1398,23 @@
 }
 -----------------------------
 
+=== Bar Height
+
+Defines the height of the bar in pixels. If this value is not set, it is calculated automatically.
+Manually setting a value can be useful, e.g., when using top and/or border bottoms on status blocks.
+
+*Syntax*:
+--------------
+height <px>
+--------------
+
+*Example*:
+--------------
+bar {
+    height 25
+}
+--------------
+
 === Colors
 
 As with i3, colors are in HTML hex format (#rrggbb). The following colors can
@@ -1856,9 +1940,15 @@
 for this purpose: It lets you input a command and sends the command to i3. It
 can also prefix this command and display a custom prompt for the input dialog.
 
+The additional +--toggle+ option will remove the mark if the window already has
+this mark, add it if the window has none or replace the current mark if it has
+another mark.
+
+Refer to +show_marks+ if you don't want marks to be shown in the window decoration.
+
 *Syntax*:
 ------------------------------
-mark identifier
+mark [--toggle] identifier
 [con_mark="identifier"] focus
 unmark identifier
 ------------------------------
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/docs/userguide.html ./docs/userguide.html
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/docs/userguide.html	2015-04-16 02:03:09.000000000 -0500
+++ ./docs/userguide.html	2015-06-20 00:55:40.000000000 -0500
@@ -3,7 +3,7 @@
 <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
 <head>
 <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
-<meta name="generator" content="AsciiDoc 8.6.8" />
+<meta name="generator" content="AsciiDoc 8.6.9" />
 <title>i3 User’s Guide</title>
 <style type="text/css">
 /* Shared CSS for AsciiDoc xhtml11 and html5 backends */
@@ -94,7 +94,9 @@
   padding: 0;
   margin: 0;
 }
-
+pre {
+  white-space: pre-wrap;
+}
 
 #author {
   color: #527bbd;
@@ -223,7 +225,7 @@
 }
 
 div.imageblock div.content { padding-left: 0; }
-span.image img { border-style: none; }
+span.image img { border-style: none; vertical-align: text-bottom; }
 a.image:visited { color: white; }
 
 dl {
@@ -1028,8 +1030,9 @@
 you moved down is directly attached to the workspace and appears on the bottom
 of the screen. A new (horizontal) container was created to accommodate the
 other two terminal windows. You will notice this when switching to tabbed mode
-(for example). You would end up having one tab called "another container" and
-the other one being the terminal window you moved down.</p></div>
+(for example). You would end up having one tab with a representation of the split
+container (e.g., "H[urxvt firefox]") and the other one being the terminal window
+you moved down.</p></div>
 </div>
 </div>
 </div>
@@ -1353,7 +1356,25 @@
 <div class="paragraph"><p>The valid criteria are the same as those for commands, see <a href="#command_criteria">[command_criteria]</a>.</p></div>
 </div>
 <div class="sect2">
-<h3 id="_variables">4.12. Variables</h3>
+<h3 id="_don_8217_t_focus_window_upon_opening">4.12. Don&#8217;t focus window upon opening</h3>
+<div class="paragraph" id="no_focus"><p>When a new window appears, it will be focused. The <code>no_focus</code> directive allows preventing
+this from happening and can be used in combination with <a href="#command_criteria">[command_criteria]</a>.</p></div>
+<div class="paragraph"><p>Note that this does not apply to all cases, e.g., when feeding data into a running application
+causing it to request being focused. To configure the behavior in such cases, refer to
+<a href="#focus_on_window_activation">[focus_on_window_activation]</a>.</p></div>
+<div class="paragraph"><p><strong>Syntax</strong>:</p></div>
+<div class="listingblock">
+<div class="content">
+<pre><code>no_focus &lt;criteria&gt;</code></pre>
+</div></div>
+<div class="paragraph"><p><strong>Example</strong>:</p></div>
+<div class="listingblock">
+<div class="content">
+<pre><code>no_focus [window_role="pop-up"]</code></pre>
+</div></div>
+</div>
+<div class="sect2">
+<h3 id="_variables">4.13. Variables</h3>
 <div class="paragraph"><p>As you learned in the section about keyboard bindings, you will have
 to configure lots of bindings containing modifier keys. If you want to save
 yourself some typing and be able to change the modifier you use later,
@@ -1377,7 +1398,7 @@
 it before starting i3 (for example in your <code>~/.xsession</code> file).</p></div>
 </div>
 <div class="sect2">
-<h3 id="_automatically_putting_clients_on_specific_workspaces">4.13. Automatically putting clients on specific workspaces</h3>
+<h3 id="_automatically_putting_clients_on_specific_workspaces">4.14. Automatically putting clients on specific workspaces</h3>
 <div class="paragraph" id="assign_workspace"><p>To automatically make a specific window show up on a specific workspace, you
 can use an <strong>assignment</strong>. You can match windows by using any criteria,
 see <a href="#command_criteria">[command_criteria]</a>. It is recommended that you match on window classes
@@ -1446,7 +1467,7 @@
 </div></div>
 </div>
 <div class="sect2">
-<h3 id="_automatically_starting_applications_on_i3_startup">4.14. Automatically starting applications on i3 startup</h3>
+<h3 id="_automatically_starting_applications_on_i3_startup">4.15. Automatically starting applications on i3 startup</h3>
 <div class="paragraph"><p>By using the <code>exec</code> keyword outside a keybinding, you can configure
 which commands will be performed by i3 on initial startup. <code>exec</code>
 commands will not run when restarting i3, if you need a command to run
@@ -1470,7 +1491,7 @@
 <div class="paragraph"><p>The flag --no-startup-id is explained in <a href="#exec">[exec]</a>.</p></div>
 </div>
 <div class="sect2">
-<h3 id="workspace_screen">4.15. Automatically putting workspaces on specific screens</h3>
+<h3 id="workspace_screen">4.16. Automatically putting workspaces on specific screens</h3>
 <div class="paragraph"><p>If you assign clients to workspaces, it might be handy to put the
 workspaces on specific screens. Also, the assignment of workspaces to screens
 will determine which workspace i3 uses for a new screen when adding screens
@@ -1494,7 +1515,7 @@
 </div></div>
 </div>
 <div class="sect2">
-<h3 id="_changing_colors">4.16. Changing colors</h3>
+<h3 id="_changing_colors">4.17. Changing colors</h3>
 <div class="paragraph"><p>You can change all colors which i3 uses to draw the window decorations.</p></div>
 <div class="paragraph"><p><strong>Syntax</strong>:</p></div>
 <div class="listingblock">
@@ -1577,7 +1598,7 @@
 from single windows outside of a split container.</p></div>
 </div>
 <div class="sect2">
-<h3 id="_interprocess_communication">4.17. Interprocess communication</h3>
+<h3 id="_interprocess_communication">4.18. Interprocess communication</h3>
 <div class="paragraph"><p>i3 uses Unix sockets to provide an IPC interface. This allows third-party
 programs to get information from i3, such as the current workspaces
 (to display a workspace bar), and to control i3.</p></div>
@@ -1599,7 +1620,7 @@
 the next section.</p></div>
 </div>
 <div class="sect2">
-<h3 id="_focus_follows_mouse">4.18. Focus follows mouse</h3>
+<h3 id="_focus_follows_mouse">4.19. Focus follows mouse</h3>
 <div class="paragraph"><p>By default, window focus follows your mouse movements. However, if you have a
 setup where your mouse usually is in your way (like a touchpad on your laptop
 which you do not want to disable completely), you might want to disable <em>focus
@@ -1618,7 +1639,7 @@
 </div></div>
 </div>
 <div class="sect2">
-<h3 id="_mouse_warping">4.19. Mouse warping</h3>
+<h3 id="_mouse_warping">4.20. Mouse warping</h3>
 <div class="paragraph"><p>By default, when switching focus to a window on a different output (e.g.
 focusing a window on workspace 3 on output VGA-1, coming from workspace 2 on
 LVDS-1), the mouse cursor is warped to the center of that window.</p></div>
@@ -1637,7 +1658,7 @@
 </div></div>
 </div>
 <div class="sect2">
-<h3 id="_popups_during_fullscreen_mode">4.20. Popups during fullscreen mode</h3>
+<h3 id="_popups_during_fullscreen_mode">4.21. Popups during fullscreen mode</h3>
 <div class="paragraph"><p>When you are in fullscreen mode, some applications still open popup windows
 (take Xpdf for example). This is because these applications may not be aware
 that they are in fullscreen mode (they do not check the corresponding hint).
@@ -1674,7 +1695,7 @@
 </div></div>
 </div>
 <div class="sect2">
-<h3 id="_focus_wrapping">4.21. Focus wrapping</h3>
+<h3 id="_focus_wrapping">4.22. Focus wrapping</h3>
 <div class="paragraph"><p>When being in a tabbed or stacked container, the first container will be
 focused when you use <code>focus down</code> on the last container&#8201;&#8212;&#8201;the focus wraps. If
 however there is another stacked/tabbed container in that direction, focus will
@@ -1696,7 +1717,7 @@
 </div></div>
 </div>
 <div class="sect2">
-<h3 id="_forcing_xinerama">4.22. Forcing Xinerama</h3>
+<h3 id="_forcing_xinerama">4.23. Forcing Xinerama</h3>
 <div class="paragraph"><p>As explained in-depth in <a href="http://i3wm.org/docs/multi-monitor.html">http://i3wm.org/docs/multi-monitor.html</a>, some X11
 video drivers (especially the nVidia binary driver) only provide support for
 Xinerama instead of RandR. In such a situation, i3 must be told to use the
@@ -1719,7 +1740,7 @@
 Xinerama, instead they are counted up, starting at 0: <code>xinerama-0</code>, <code>xinerama-1</code>, …</p></div>
 </div>
 <div class="sect2">
-<h3 id="_automatic_back_and_forth_when_switching_to_the_current_workspace">4.23. Automatic back-and-forth when switching to the current workspace</h3>
+<h3 id="_automatic_back_and_forth_when_switching_to_the_current_workspace">4.24. Automatic back-and-forth when switching to the current workspace</h3>
 <div class="paragraph"><p>This configuration directive enables automatic <code>workspace back_and_forth</code> (see
 <a href="#back_and_forth">[back_and_forth]</a>) when switching to the workspace that is currently focused.</p></div>
 <div class="paragraph"><p>For instance: Assume you are on workspace "1: www" and switch to "2: IM" using
@@ -1737,7 +1758,7 @@
 </div></div>
 </div>
 <div class="sect2">
-<h3 id="_delaying_urgency_hint_reset_on_workspace_change">4.24. Delaying urgency hint reset on workspace change</h3>
+<h3 id="_delaying_urgency_hint_reset_on_workspace_change">4.25. Delaying urgency hint reset on workspace change</h3>
 <div class="paragraph"><p>If an application on another workspace sets an urgency hint, switching to this
 workspace may lead to immediate focus of the application, which also means the
 window decoration color would be immediately reset to <code>client.focused</code>. This
@@ -1758,6 +1779,71 @@
 <pre><code>force_display_urgency_hint 500 ms</code></pre>
 </div></div>
 </div>
+<div class="sect2">
+<h3 id="_focus_on_window_activation">4.26. Focus on window activation</h3>
+<div class="paragraph" id="focus_on_window_activation"><p>If a window is activated, e.g., via <code>google-chrome www.google.com</code>, it may request
+to take focus. Since this may not preferable, different reactions can be configured.</p></div>
+<div class="paragraph"><p>Note that this may not affect windows that are being opened. To prevent new windows
+from being focused, see <a href="#no_focus">[no_focus]</a>.</p></div>
+<div class="paragraph"><p><strong>Syntax</strong>:</p></div>
+<div class="listingblock">
+<div class="content">
+<pre><code>focus_on_window_activation &lt;smart|urgent|focus|none&gt;</code></pre>
+</div></div>
+<div class="paragraph"><p>The different modes will act as follows:</p></div>
+<div class="dlist"><dl>
+<dt class="hdlist1">
+smart
+</dt>
+<dd>
+<p>
+    This is the default behavior. If the window requesting focus is on an active
+    workspace, it will receive the focus. Otherwise, the urgency hint will be set.
+</p>
+</dd>
+<dt class="hdlist1">
+urgent
+</dt>
+<dd>
+<p>
+    The window will always be marked urgent, but the focus will not be stolen.
+</p>
+</dd>
+<dt class="hdlist1">
+focus
+</dt>
+<dd>
+<p>
+    The window will always be focused and not be marked urgent.
+</p>
+</dd>
+<dt class="hdlist1">
+none
+</dt>
+<dd>
+<p>
+    The window will neither be focused, nor be marked urgent.
+</p>
+</dd>
+</dl></div>
+</div>
+<div class="sect2">
+<h3 id="_drawing_marks_on_window_decoration">4.27. Drawing marks on window decoration</h3>
+<div class="paragraph"><p>If activated, marks on windows are drawn in their window decoration. However,
+any mark starting with an underscore in its name (<code>_</code>) will not be drawn even if
+this option is activated.</p></div>
+<div class="paragraph"><p>The default for this option is <code>yes</code>.</p></div>
+<div class="paragraph"><p><strong>Syntax</strong>:</p></div>
+<div class="listingblock">
+<div class="content">
+<pre><code>show_marks [yes|no]</code></pre>
+</div></div>
+<div class="paragraph"><p><strong>Example</strong>:</p></div>
+<div class="listingblock">
+<div class="content">
+<pre><code>show_marks yes</code></pre>
+</div></div>
+</div>
 </div>
 </div>
 <div class="sect1">
@@ -2104,7 +2190,24 @@
 </div></div>
 </div>
 <div class="sect2">
-<h3 id="_colors">5.14. Colors</h3>
+<h3 id="_bar_height">5.14. Bar Height</h3>
+<div class="paragraph"><p>Defines the height of the bar in pixels. If this value is not set, it is calculated automatically.
+Manually setting a value can be useful, e.g., when using top and/or border bottoms on status blocks.</p></div>
+<div class="paragraph"><p><strong>Syntax</strong>:</p></div>
+<div class="listingblock">
+<div class="content">
+<pre><code>height &lt;px&gt;</code></pre>
+</div></div>
+<div class="paragraph"><p><strong>Example</strong>:</p></div>
+<div class="listingblock">
+<div class="content">
+<pre><code>bar {
+    height 25
+}</code></pre>
+</div></div>
+</div>
+<div class="sect2">
+<h3 id="_colors">5.15. Colors</h3>
 <div class="paragraph"><p>As with i3, colors are in HTML hex format (#rrggbb). The following colors can
 be configured at the moment:</p></div>
 <div class="dlist"><dl>
@@ -2726,10 +2829,14 @@
 window, you cannot simply bind it to a key.  <code>i3-input</code> is a tool created
 for this purpose: It lets you input a command and sends the command to i3. It
 can also prefix this command and display a custom prompt for the input dialog.</p></div>
+<div class="paragraph"><p>The additional <code>--toggle</code> option will remove the mark if the window already has
+this mark, add it if the window has none or replace the current mark if it has
+another mark.</p></div>
+<div class="paragraph"><p>Refer to <code>show_marks</code> if you don&#8217;t want marks to be shown in the window decoration.</p></div>
 <div class="paragraph"><p><strong>Syntax</strong>:</p></div>
 <div class="listingblock">
 <div class="content">
-<pre><code>mark identifier
+<pre><code>mark [--toggle] identifier
 [con_mark="identifier"] focus
 unmark identifier</code></pre>
 </div></div>
@@ -3085,7 +3192,7 @@
 <div id="footnotes"><hr /></div>
 <div id="footer">
 <div id="footer-text">
-Last updated 2015-04-16 09:02:58 CEST
+Last updated 2015-06-19 23:47:23 CDT
 </div>
 </div>
 </body>
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/docs/wsbar.html ./docs/wsbar.html
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/docs/wsbar.html	2015-04-16 02:03:09.000000000 -0500
+++ ./docs/wsbar.html	2015-06-20 00:55:40.000000000 -0500
@@ -3,7 +3,7 @@
 <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
 <head>
 <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
-<meta name="generator" content="AsciiDoc 8.6.8" />
+<meta name="generator" content="AsciiDoc 8.6.9" />
 <title>External workspace bars</title>
 <style type="text/css">
 /* Shared CSS for AsciiDoc xhtml11 and html5 backends */
@@ -94,7 +94,9 @@
   padding: 0;
   margin: 0;
 }
-
+pre {
+  white-space: pre-wrap;
+}
 
 #author {
   color: #527bbd;
@@ -223,7 +225,7 @@
 }
 
 div.imageblock div.content { padding-left: 0; }
-span.image img { border-style: none; }
+span.image img { border-style: none; vertical-align: text-bottom; }
 a.image:visited { color: white; }
 
 dl {
@@ -840,7 +842,7 @@
 <div id="footnotes"><hr /></div>
 <div id="footer">
 <div id="footer-text">
-Last updated 2015-04-16 09:02:58 CEST
+Last updated 2015-06-19 23:47:23 CDT
 </div>
 </div>
 </body>
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/i3-config-wizard/main.c ./i3-config-wizard/main.c
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/i3-config-wizard/main.c	2015-04-16 02:03:02.000000000 -0500
+++ ./i3-config-wizard/main.c	2015-06-20 00:55:28.000000000 -0500
@@ -462,38 +462,6 @@
 }
 
 /*
- * This function resolves ~ in pathnames.
- * It may resolve wildcards in the first part of the path, but if no match
- * or multiple matches are found, it just returns a copy of path as given.
- *
- */
-static char *resolve_tilde(const char *path) {
-    static glob_t globbuf;
-    char *head, *tail, *result;
-
-    tail = strchr(path, '/');
-    head = strndup(path, tail ? (size_t)(tail - path) : strlen(path));
-
-    int res = glob(head, GLOB_TILDE, NULL, &globbuf);
-    free(head);
-    /* no match, or many wildcard matches are bad */
-    if (res == GLOB_NOMATCH || globbuf.gl_pathc != 1)
-        result = strdup(path);
-    else if (res != 0) {
-        err(1, "glob() failed");
-    } else {
-        head = globbuf.gl_pathv[0];
-        result = calloc(1, strlen(head) + (tail ? strlen(tail) : 0) + 1);
-        strncpy(result, head, strlen(head));
-        if (tail)
-            strncat(result, tail, strlen(tail));
-    }
-    globfree(&globbuf);
-
-    return result;
-}
-
-/*
  * Handles expose events, that is, draws the window contents.
  *
  */
@@ -514,17 +482,23 @@
         set_font_colors(pixmap_gc, get_colorpixel("#FFFFFF"), get_colorpixel("#000000"));
 
         txt(logical_px(10), 2, "You have not configured i3 yet.");
-        txt(logical_px(10), 3, "Do you want me to generate ~/.i3/config?");
-        txt(logical_px(85), 5, "Yes, generate ~/.i3/config");
-        txt(logical_px(85), 7, "No, I will use the defaults");
+        txt(logical_px(10), 3, "Do you want me to generate a config at");
+
+        char *msg;
+        sasprintf(&msg, "%s?", config_path);
+        txt(logical_px(10), 4, msg);
+        free(msg);
+
+        txt(logical_px(85), 6, "Yes, generate the config");
+        txt(logical_px(85), 8, "No, I will use the defaults");
 
         /* green */
         set_font_colors(pixmap_gc, get_colorpixel("#00FF00"), get_colorpixel("#000000"));
-        txt(logical_px(25), 5, "<Enter>");
+        txt(logical_px(25), 6, "<Enter>");
 
         /* red */
         set_font_colors(pixmap_gc, get_colorpixel("#FF0000"), get_colorpixel("#000000"));
-        txt(logical_px(31), 7, "<ESC>");
+        txt(logical_px(31), 8, "<ESC>");
     }
 
     if (current_step == STEP_GENERATE) {
@@ -534,7 +508,7 @@
         txt(logical_px(85), 4, "Win as default modifier");
         txt(logical_px(85), 5, "Alt as default modifier");
         txt(logical_px(10), 7, "Afterwards, press");
-        txt(logical_px(85), 9, "to write ~/.i3/config");
+        txt(logical_px(85), 9, "to write the config");
         txt(logical_px(85), 10, "to abort");
 
         /* the not-selected modifier */
@@ -772,7 +746,7 @@
 }
 
 int main(int argc, char *argv[]) {
-    config_path = resolve_tilde("~/.i3/config");
+    char *xdg_config_home;
     socket_path = getenv("I3SOCK");
     char *pattern = "pango:monospace 8";
     char *patternbold = "pango:monospace bold 8";
@@ -806,20 +780,29 @@
         }
     }
 
-    /* Check if the destination config file does not exist but the path is
-     * writable. If not, exit now, this program is not useful in that case. */
-    struct stat stbuf;
-    if (stat(config_path, &stbuf) == 0) {
-        printf("The config file \"%s\" already exists. Exiting.\n", config_path);
+    char *path = get_config_path(NULL, false);
+    if (path != NULL) {
+        printf("The config file \"%s\" already exists. Exiting.\n", path);
+        free(path);
         return 0;
     }
 
-    /* Create ~/.i3 if it does not yet exist */
-    char *config_dir = resolve_tilde("~/.i3");
+    /* Always write to $XDG_CONFIG_HOME/i3/config by default. */
+    if ((xdg_config_home = getenv("XDG_CONFIG_HOME")) == NULL)
+        xdg_config_home = "~/.config";
+
+    xdg_config_home = resolve_tilde(xdg_config_home);
+    sasprintf(&config_path, "%s/i3/config", xdg_config_home);
+
+    /* Create $XDG_CONFIG_HOME/i3 if it does not yet exist */
+    char *config_dir;
+    struct stat stbuf;
+    sasprintf(&config_dir, "%s/i3", xdg_config_home);
     if (stat(config_dir, &stbuf) != 0)
-        if (mkdir(config_dir, 0755) == -1)
-            err(1, "mkdir(%s) failed", config_dir);
+        if (!mkdirp(config_dir))
+            err(EXIT_FAILURE, "mkdirp(%s) failed", config_dir);
     free(config_dir);
+    free(xdg_config_home);
 
     int fd;
     if ((fd = open(config_path, O_CREAT | O_RDWR, 0644)) == -1) {
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/i3-input/main.c ./i3-input/main.c
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/i3-input/main.c	2015-04-16 02:03:09.000000000 -0500
+++ ./i3-input/main.c	2015-06-20 00:55:40.000000000 -0500
@@ -314,6 +314,50 @@
     return 1;
 }
 
+static xcb_rectangle_t get_window_position(void) {
+    xcb_rectangle_t result = (xcb_rectangle_t){logical_px(50), logical_px(50), logical_px(500), font.height + logical_px(8)};
+
+    xcb_get_input_focus_reply_t *input_focus = NULL;
+    xcb_get_geometry_reply_t *geometry = NULL;
+    xcb_translate_coordinates_reply_t *coordinates = NULL;
+
+    /* In rare cases, the window holding the input focus might disappear while we are figuring out its
+     * position. To avoid this, we grab the server in the meantime. */
+    xcb_grab_server(conn);
+
+    input_focus = xcb_get_input_focus_reply(conn, xcb_get_input_focus(conn), NULL);
+    if (input_focus == NULL || input_focus->focus == XCB_NONE) {
+        DLOG("Failed to receive the current input focus or no window has the input focus right now.\n");
+        goto free_resources;
+    }
+
+    geometry = xcb_get_geometry_reply(conn, xcb_get_geometry(conn, input_focus->focus), NULL);
+    if (geometry == NULL) {
+        DLOG("Failed to received window geometry.\n");
+        goto free_resources;
+    }
+
+    coordinates = xcb_translate_coordinates_reply(
+        conn, xcb_translate_coordinates(conn, input_focus->focus, root, geometry->x, geometry->y), NULL);
+    if (coordinates == NULL) {
+        DLOG("Failed to translate coordinates.\n");
+        goto free_resources;
+    }
+
+    DLOG("Determined coordinates of window with input focus at x = %i / y = %i", coordinates->dst_x, coordinates->dst_y);
+    result.x += coordinates->dst_x;
+    result.y += coordinates->dst_y;
+
+free_resources:
+    xcb_ungrab_server(conn);
+    xcb_flush(conn);
+
+    FREE(input_focus);
+    FREE(geometry);
+    FREE(coordinates);
+    return result;
+}
+
 int main(int argc, char *argv[]) {
     format = strdup("%s");
     socket_path = getenv("I3SOCK");
@@ -402,15 +446,17 @@
     if (prompt != NULL)
         prompt_offset = predict_text_width(prompt);
 
+    const xcb_rectangle_t win_pos = get_window_position();
+
     /* Open an input window */
     win = xcb_generate_id(conn);
     xcb_create_window(
         conn,
         XCB_COPY_FROM_PARENT,
-        win,                                                                          /* the window id */
-        root,                                                                         /* parent == root */
-        logical_px(50), logical_px(50), logical_px(500), font.height + logical_px(8), /* dimensions */
-        0,                                                                            /* X11 border = 0, we draw our own */
+        win,                                                 /* the window id */
+        root,                                                /* parent == root */
+        win_pos.x, win_pos.y, win_pos.width, win_pos.height, /* dimensions */
+        0,                                                   /* X11 border = 0, we draw our own */
         XCB_WINDOW_CLASS_INPUT_OUTPUT,
         XCB_WINDOW_CLASS_COPY_FROM_PARENT, /* copy visual from parent */
         XCB_CW_BACK_PIXEL | XCB_CW_OVERRIDE_REDIRECT | XCB_CW_EVENT_MASK,
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/i3-nagbar/i3-nagbar.mk ./i3-nagbar/i3-nagbar.mk
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/i3-nagbar/i3-nagbar.mk	2015-04-16 02:03:02.000000000 -0500
+++ ./i3-nagbar/i3-nagbar.mk	2015-06-20 00:55:28.000000000 -0500
@@ -4,8 +4,8 @@
 
 i3_nagbar_SOURCES := $(wildcard i3-nagbar/*.c)
 i3_nagbar_HEADERS := $(wildcard i3-nagbar/*.h)
-i3_nagbar_CFLAGS   = $(XCB_CFLAGS) $(PANGO_CFLAGS)
-i3_nagbar_LIBS     = $(XCB_LIBS) $(PANGO_LIBS)
+i3_nagbar_CFLAGS   = $(XCB_CFLAGS) $(XCB_WM_CFLAGS) $(PANGO_CFLAGS)
+i3_nagbar_LIBS     = $(XCB_LIBS) $(XCB_WM_LIBS) $(PANGO_LIBS)
 
 i3_nagbar_OBJECTS := $(i3_nagbar_SOURCES:.c=.o)
 
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/i3-nagbar/main.c ./i3-nagbar/main.c
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/i3-nagbar/main.c	2015-04-16 02:03:02.000000000 -0500
+++ ./i3-nagbar/main.c	2015-06-20 00:55:28.000000000 -0500
@@ -27,6 +27,7 @@
 #include <xcb/xcb.h>
 #include <xcb/xcb_aux.h>
 #include <xcb/xcb_event.h>
+#include <xcb/randr.h>
 
 #include "libi3.h"
 #include "i3-nagbar.h"
@@ -288,6 +289,60 @@
     return 1;
 }
 
+/**
+ * Return the position and size the i3-nagbar window should use.
+ * This will be the primary output or a fallback if it cannot be determined.
+ */
+static xcb_rectangle_t get_window_position(void) {
+    /* Default values if we cannot determine the primary output or its CRTC info. */
+    xcb_rectangle_t result = (xcb_rectangle_t){50, 50, 500, font.height + logical_px(8) + logical_px(8)};
+
+    xcb_randr_get_screen_resources_current_cookie_t rcookie = xcb_randr_get_screen_resources_current(conn, root);
+    xcb_randr_get_output_primary_cookie_t pcookie = xcb_randr_get_output_primary(conn, root);
+
+    xcb_randr_get_output_primary_reply_t *primary = NULL;
+    xcb_randr_get_screen_resources_current_reply_t *res = NULL;
+
+    if ((primary = xcb_randr_get_output_primary_reply(conn, pcookie, NULL)) == NULL) {
+        DLOG("Could not determine the primary output.\n");
+        goto free_resources;
+    }
+
+    if ((res = xcb_randr_get_screen_resources_current_reply(conn, rcookie, NULL)) == NULL) {
+        goto free_resources;
+    }
+
+    xcb_randr_get_output_info_reply_t *output =
+        xcb_randr_get_output_info_reply(conn,
+                                        xcb_randr_get_output_info(conn, primary->output, res->config_timestamp),
+                                        NULL);
+    if (output == NULL || output->crtc == XCB_NONE)
+        goto free_resources;
+
+    xcb_randr_get_crtc_info_reply_t *crtc =
+        xcb_randr_get_crtc_info_reply(conn,
+                                      xcb_randr_get_crtc_info(conn, output->crtc, res->config_timestamp),
+                                      NULL);
+    if (crtc == NULL)
+        goto free_resources;
+
+    DLOG("Found primary output on position x = %i / y = %i / w = %i / h = %i",
+         crtc->x, crtc->y, crtc->width, crtc->height);
+    if (crtc->width == 0 || crtc->height == 0) {
+        DLOG("Primary output is not active, ignoring it.\n");
+        goto free_resources;
+    }
+
+    result.x = crtc->x;
+    result.y = crtc->y;
+    goto free_resources;
+
+free_resources:
+    FREE(res);
+    FREE(primary);
+    return result;
+}
+
 int main(int argc, char *argv[]) {
     /* The following lines are a terribly horrible kludge. Because terminal
      * emulators have different ways of interpreting the -e command line
@@ -410,16 +465,18 @@
     font = load_font(pattern, true);
     set_font(&font);
 
+    xcb_rectangle_t win_pos = get_window_position();
+
     /* Open an input window */
     win = xcb_generate_id(conn);
 
     xcb_create_window(
         conn,
         XCB_COPY_FROM_PARENT,
-        win,                                                                         /* the window id */
-        root,                                                                        /* parent == root */
-        50, 50, 500, font.height + logical_px(8) + logical_px(8) /* 8 px padding */, /* dimensions */
-        0,                                                                           /* x11 border = 0, we draw our own */
+        win,                                                 /* the window id */
+        root,                                                /* parent == root */
+        win_pos.x, win_pos.y, win_pos.width, win_pos.height, /* dimensions */
+        0,                                                   /* x11 border = 0, we draw our own */
         XCB_WINDOW_CLASS_INPUT_OUTPUT,
         XCB_WINDOW_CLASS_COPY_FROM_PARENT, /* copy visual from parent */
         XCB_CW_BACK_PIXEL | XCB_CW_EVENT_MASK,
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/i3bar/include/common.h ./i3bar/include/common.h
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/i3bar/include/common.h	2015-04-16 02:03:02.000000000 -0500
+++ ./i3bar/include/common.h	2015-06-20 00:55:28.000000000 -0500
@@ -38,6 +38,8 @@
     i3String *short_text;
 
     char *color;
+    char *background;
+    char *border;
 
     /* min_width can be specified either as a numeric value (in pixels) or as a
      * string. For strings, we set min_width to the measured text width of
@@ -49,6 +51,10 @@
 
     bool urgent;
     bool no_separator;
+    uint32_t border_top;
+    uint32_t border_right;
+    uint32_t border_bottom;
+    uint32_t border_left;
     bool is_markup;
 
     /* The amount of pixels necessary to render a separater after the block. */
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/i3bar/include/config.h ./i3bar/include/config.h
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/i3bar/include/config.h	2015-04-16 02:03:02.000000000 -0500
+++ ./i3bar/include/config.h	2015-06-20 00:55:28.000000000 -0500
@@ -28,6 +28,7 @@
     char *wheel_down_cmd;
     position_t position;
     int verbose;
+    uint32_t bar_height;
     struct xcb_color_strings_t colors;
     bool disable_binding_mode_indicator;
     bool disable_ws;
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/i3bar/src/child.c ./i3bar/src/child.c
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/i3bar/src/child.c	2015-04-16 02:03:02.000000000 -0500
+++ ./i3bar/src/child.c	2015-06-20 00:55:28.000000000 -0500
@@ -75,6 +75,8 @@
             FREE(first->name);
             FREE(first->instance);
             FREE(first->min_width_str);
+            FREE(first->background);
+            FREE(first->border);
         }
 
         TAILQ_REMOVE(head, first, blocks);
@@ -167,6 +169,12 @@
     else
         ctx->block.sep_block_width = logical_px(8) + separator_symbol_width;
 
+    /* If a border is set, by default we draw all four borders. */
+    ctx->block.border_top = 1;
+    ctx->block.border_right = 1;
+    ctx->block.border_bottom = 1;
+    ctx->block.border_left = 1;
+
     return 1;
 }
 
@@ -205,6 +213,12 @@
         sasprintf(&(ctx->block.color), "%.*s", len, val);
         return 1;
     }
+    if (strcasecmp(ctx->last_map_key, "background") == 0) {
+        sasprintf(&(ctx->block.background), "%.*s", len, val);
+    }
+    if (strcasecmp(ctx->last_map_key, "border") == 0) {
+        sasprintf(&(ctx->block.border), "%.*s", len, val);
+    }
     if (strcasecmp(ctx->last_map_key, "markup") == 0) {
         ctx->block.is_markup = (len == strlen("pango") && !strncasecmp((const char *)val, "pango", strlen("pango")));
         return 1;
@@ -254,6 +268,22 @@
         ctx->block.sep_block_width = (uint32_t)val;
         return 1;
     }
+    if (strcasecmp(ctx->last_map_key, "border_top") == 0) {
+        ctx->block.border_top = (uint32_t)val;
+        return 1;
+    }
+    if (strcasecmp(ctx->last_map_key, "border_right") == 0) {
+        ctx->block.border_right = (uint32_t)val;
+        return 1;
+    }
+    if (strcasecmp(ctx->last_map_key, "border_bottom") == 0) {
+        ctx->block.border_bottom = (uint32_t)val;
+        return 1;
+    }
+    if (strcasecmp(ctx->last_map_key, "border_left") == 0) {
+        ctx->block.border_left = (uint32_t)val;
+        return 1;
+    }
 
     return 1;
 }
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/i3bar/src/config.c ./i3bar/src/config.c
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/i3bar/src/config.c	2015-04-16 02:03:02.000000000 -0500
+++ ./i3bar/src/config.c	2015-06-20 00:55:28.000000000 -0500
@@ -53,6 +53,18 @@
     return 1;
 }
 
+/* Parse an integer */
+static int config_integer_cb(void *params_, long long val) {
+    if (!strcmp(cur_key, "bar_height")) {
+        DLOG("bar_height = %lld", val);
+        config.bar_height = (uint32_t)val;
+        return 1;
+    }
+
+    DLOG("got unexpected integer %lld for cur_key = %s\n", val, cur_key);
+    return 0;
+}
+
 /*
  * Parse a string
  *
@@ -232,6 +244,7 @@
 /* A datastructure to pass all these callbacks to yajl */
 static yajl_callbacks outputs_callbacks = {
     .yajl_null = config_null_cb,
+    .yajl_integer = config_integer_cb,
     .yajl_boolean = config_boolean_cb,
     .yajl_string = config_string_cb,
     .yajl_map_key = config_map_key_cb,
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/i3bar/src/xcb.c ./i3bar/src/xcb.c
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/i3bar/src/xcb.c	2015-04-16 02:03:02.000000000 -0500
+++ ./i3bar/src/xcb.c	2015-06-20 00:55:28.000000000 -0500
@@ -60,7 +60,7 @@
 /* The font we'll use */
 static i3Font font;
 
-/* Overall height of the bar (based on font size) */
+/* Overall height of the size */
 int bar_height;
 
 /* These are only relevant for XKB, which we only need for grabbing modifiers */
@@ -178,7 +178,7 @@
         uint32_t separator_x = MAX(x - block->sep_block_width, center_x - separator_symbol_width / 2);
         set_font_colors(statusline_ctx, colors.sep_fg, colors.bar_bg);
         draw_text(config.separator_symbol, statusline_pm, statusline_ctx,
-                  separator_x, logical_px(ws_voff_px), x - separator_x);
+                  separator_x, bar_height / 2 - font.height / 2, x - separator_x);
     }
 }
 
@@ -204,6 +204,8 @@
             continue;
 
         block->width = predict_text_width(block->full_text);
+        /* Add some padding. */
+        block->width += logical_px(2) + block->border_left + block->border_right;
 
         /* Compute offset and append for text aligment in min_width. */
         if (block->min_width <= block->width) {
@@ -247,29 +249,54 @@
     TAILQ_FOREACH(block, &statusline_head, blocks) {
         if (i3string_get_num_bytes(block->full_text) == 0)
             continue;
-        uint32_t fg_color;
 
-        /* If this block is urgent, draw it with the defined color and border. */
-        if (block->urgent) {
-            fg_color = colors.urgent_ws_fg;
+        uint32_t fg_color = (block->color ? get_colorpixel(block->color) : colors.bar_fg);
+        if (block->border || block->background || block->urgent) {
+            if (block->urgent)
+                fg_color = colors.urgent_ws_fg;
 
             uint32_t mask = XCB_GC_FOREGROUND | XCB_GC_BACKGROUND;
 
-            /* Draw the background */
-            uint32_t bg_color = colors.urgent_ws_bg;
+            /* Let's determine the colors first. */
+            uint32_t border_color = colors.bar_bg;
+            uint32_t bg_color = colors.bar_bg;
+            if (block->urgent) {
+                border_color = colors.urgent_ws_border;
+                bg_color = colors.urgent_ws_bg;
+            } else {
+                if (block->border)
+                    border_color = get_colorpixel(block->border);
+
+                if (block->background)
+                    bg_color = get_colorpixel(block->background);
+            }
+
+            /* Draw the border. */
+            uint32_t border_values[] = {border_color, border_color};
+            xcb_change_gc(xcb_connection, statusline_ctx, mask, border_values);
+
+            xcb_rectangle_t border_rect = {x, logical_px(1),
+                                           block->width + block->x_offset + block->x_append, bar_height - logical_px(2)};
+            xcb_poly_fill_rectangle(xcb_connection, statusline_pm, statusline_ctx, 1, &border_rect);
+
+            /* Draw the background. */
+            bool is_border = !!block->border;
             uint32_t bg_values[] = {bg_color, bg_color};
             xcb_change_gc(xcb_connection, statusline_ctx, mask, bg_values);
 
-            /* The urgent background “overshoots” by 2 px so that the text that
-             * is printed onto it will not be look so cut off. */
-            xcb_rectangle_t bg_rect = {x - logical_px(2), logical_px(1), block->width + logical_px(4), bar_height - logical_px(2)};
+            xcb_rectangle_t bg_rect = {
+                x + is_border * block->border_left,
+                logical_px(1) + is_border * block->border_top,
+                block->width + block->x_offset + block->x_append - is_border * (block->border_right + block->border_left),
+                bar_height - is_border * (block->border_bottom + block->border_top) - logical_px(2)};
             xcb_poly_fill_rectangle(xcb_connection, statusline_pm, statusline_ctx, 1, &bg_rect);
-        } else {
-            fg_color = (block->color ? get_colorpixel(block->color) : colors.bar_fg);
         }
 
         set_font_colors(statusline_ctx, fg_color, colors.bar_bg);
-        draw_text(block->full_text, statusline_pm, statusline_ctx, x + block->x_offset, logical_px(ws_voff_px), block->width);
+        draw_text(block->full_text, statusline_pm, statusline_ctx,
+                  x + block->x_offset + logical_px(1) + block->border_left,
+                  bar_height / 2 - font.height / 2,
+                  block->width - logical_px(1) - block->border_left - block->border_right);
         x += block->width + block->sep_block_width + block->x_offset + block->x_append;
 
         /* If this is not the last block, draw a separator. */
@@ -590,9 +617,8 @@
                 continue;
             clients++;
 
-            DLOG("Configuring tray window %08x to x=%d\n",
-                 trayclient->win, output->rect.w - (clients * (font.height + logical_px(2))));
             uint32_t x = output->rect.w - (clients * (font.height + logical_px(2)));
+            DLOG("Configuring tray window %08x to x=%d\n", trayclient->win, x);
             xcb_configure_window(xcb_connection,
                                  trayclient->win,
                                  XCB_CONFIG_WINDOW_X,
@@ -703,7 +729,7 @@
                                 client,
                                 output->bar,
                                 output->rect.w - font.height - 2,
-                                2);
+                                bar_height / 2 - font.height / 2);
             /* We reconfigure the window to use a reasonable size. The systray
              * specification explicitly says:
              *   Tray icons may be assigned any size by the system tray, and
@@ -1213,8 +1239,16 @@
     /* Load the font */
     font = load_font(fontname, true);
     set_font(&font);
-    DLOG("Calculated font height: %d\n", font.height);
-    bar_height = font.height + 2 * logical_px(ws_voff_px);
+    DLOG("Calculated font-height: %d\n", font.height);
+
+    /*
+     * If the bar height was explicitly set, use it. Otherwise, calculate it
+     * based on the font size.
+     */
+    if (config.bar_height <= 0)
+        bar_height = font.height + 2 * logical_px(ws_voff_px);
+    else
+        bar_height = config.bar_height;
 
     if (config.separator_symbol)
         separator_symbol_width = predict_text_width(config.separator_symbol);
@@ -1853,7 +1887,7 @@
                 xcb_rectangle_t rect_border = {workspace_width,
                                                logical_px(1),
                                                ws_walk->name_width + 2 * logical_px(ws_hoff_px) + 2 * logical_px(1),
-                                               font.height + 2 * logical_px(ws_voff_px) - 2 * logical_px(1)};
+                                               bar_height - 2 * logical_px(1)};
                 xcb_poly_fill_rectangle(xcb_connection,
                                         outputs_walk->buffer,
                                         outputs_walk->bargc,
@@ -1867,7 +1901,7 @@
                 xcb_rectangle_t rect = {workspace_width + logical_px(1),
                                         2 * logical_px(1),
                                         ws_walk->name_width + 2 * logical_px(ws_hoff_px),
-                                        font.height + 2 * logical_px(ws_voff_px) - 4 * logical_px(1)};
+                                        bar_height - 4 * logical_px(1)};
                 xcb_poly_fill_rectangle(xcb_connection,
                                         outputs_walk->buffer,
                                         outputs_walk->bargc,
@@ -1876,7 +1910,7 @@
                 set_font_colors(outputs_walk->bargc, fg_color, bg_color);
                 draw_text(ws_walk->name, outputs_walk->buffer, outputs_walk->bargc,
                           workspace_width + logical_px(ws_hoff_px) + logical_px(1),
-                          logical_px(ws_voff_px),
+                          bar_height / 2 - font.height / 2,
                           ws_walk->name_width);
 
                 workspace_width += 2 * logical_px(ws_hoff_px) + 2 * logical_px(1) + ws_walk->name_width;
@@ -1897,10 +1931,7 @@
                           outputs_walk->bargc,
                           mask,
                           vals_border);
-            xcb_rectangle_t rect_border = {workspace_width,
-                                           logical_px(1),
-                                           binding.width + 2 * logical_px(ws_hoff_px) + 2 * logical_px(1),
-                                           font.height + 2 * logical_px(ws_voff_px) - 2 * logical_px(1)};
+            xcb_rectangle_t rect_border = {workspace_width, logical_px(1), binding.width + 2 * logical_px(ws_hoff_px) + 2 * logical_px(1), bar_height - 2 * logical_px(1)};
             xcb_poly_fill_rectangle(xcb_connection,
                                     outputs_walk->buffer,
                                     outputs_walk->bargc,
@@ -1912,10 +1943,7 @@
                           outputs_walk->bargc,
                           mask,
                           vals);
-            xcb_rectangle_t rect = {workspace_width + logical_px(1),
-                                    2 * logical_px(1),
-                                    binding.width + 2 * logical_px(ws_hoff_px),
-                                    font.height + 2 * logical_px(ws_voff_px) - 4 * logical_px(1)};
+            xcb_rectangle_t rect = {workspace_width + logical_px(1), 2 * logical_px(1), binding.width + 2 * logical_px(ws_hoff_px), bar_height - 4 * logical_px(1)};
             xcb_poly_fill_rectangle(xcb_connection,
                                     outputs_walk->buffer,
                                     outputs_walk->bargc,
@@ -1923,12 +1951,7 @@
                                     &rect);
 
             set_font_colors(outputs_walk->bargc, fg_color, bg_color);
-            draw_text(binding.name,
-                      outputs_walk->buffer,
-                      outputs_walk->bargc,
-                      workspace_width + logical_px(ws_hoff_px) + logical_px(1),
-                      logical_px(ws_voff_px),
-                      binding.width);
+            draw_text(binding.name, outputs_walk->buffer, outputs_walk->bargc, workspace_width + logical_px(ws_hoff_px) + logical_px(1), bar_height / 2 - font.height / 2, binding.width);
 
             unhide = true;
             workspace_width += 2 * logical_px(ws_hoff_px) + 2 * logical_px(1) + binding.width;
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/include/commands.h ./include/commands.h
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/include/commands.h	2015-04-16 02:03:02.000000000 -0500
+++ ./include/commands.h	2015-06-20 00:55:28.000000000 -0500
@@ -109,10 +109,10 @@
 void cmd_workspace_name(I3_CMD, char *name);
 
 /**
- * Implementation of 'mark <mark>'
+ * Implementation of 'mark [--toggle] <mark>'
  *
  */
-void cmd_mark(I3_CMD, char *mark);
+void cmd_mark(I3_CMD, char *mark, char *toggle);
 
 /**
  * Implementation of 'unmark [mark]'
@@ -287,3 +287,9 @@
  *
  */
 void cmd_debuglog(I3_CMD, char *argument);
+
+/**
+ * Implementation of 'gaps inner|outer current|all set|plus|minus <px>'
+ *
+ */
+void cmd_gaps(I3_CMD, char *type, char *scope, char *mode, char *value);
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/include/con.h ./include/con.h
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/include/con.h	2015-04-16 02:03:02.000000000 -0500
+++ ./include/con.h	2015-06-20 00:55:28.000000000 -0500
@@ -140,6 +140,13 @@
 int con_num_children(Con *con);
 
 /**
+ * Returns the number of visible non-floating children of this container.
+ * For example, if the container contains a hsplit which has two children,
+ * this will return 2 instead of 1.
+ */
+int con_num_visible_children(Con *con);
+
+/**
  * Attaches the given container to the given parent. This happens when moving
  * a container or when inserting a new container at a specific place in the
  * tree.
@@ -358,7 +365,20 @@
 char *con_get_tree_representation(Con *con);
 
 /**
+  * Calculates the effective gap sizes for a container depending
+  * on whether it is adjacent to the edge of the screen or another
+  * container.
+  */
+gaps_t calculate_effective_gaps(Con *con);
+
+/**
  * force parent split containers to be redrawn
  *
  */
 void con_force_split_parents_redraw(Con *con);
+
+/**
+ * Recursively check whether the (potential) parent container
+ * contains the (potential) child container.
+ */
+bool con_has_parent(Con *parent, Con *child);
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/include/config.h ./include/config.h
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/include/config.h	2015-04-16 02:03:02.000000000 -0500
+++ ./include/config.h	2015-06-20 00:55:28.000000000 -0500
@@ -167,6 +167,22 @@
      * flag can be delayed using an urgency timer. */
     float workspace_urgency_timer;
 
+    /** Behavior when a window sends a NET_ACTIVE_WINDOW message. */
+    enum {
+        /* Focus if the target workspace is visible, set urgency hint otherwise. */
+        FOWA_SMART,
+        /* Always set the urgency hint. */
+        FOWA_URGENT,
+        /* Always focus the window. */
+        FOWA_FOCUS,
+        /* Ignore the request (no focus, no urgency hint). */
+        FOWA_NONE
+    } focus_on_window_activation;
+
+    /** Specifies whether or not marks should be displayed in the window
+     * decoration. Marks starting with a "_" will be ignored either way. */
+    bool show_marks;
+
     /** The default border style for new windows. */
     border_style_t default_border;
 
@@ -213,6 +229,15 @@
 
     /* The number of currently parsed barconfigs */
     int number_barconfigs;
+
+    /* Gap sizes */
+    gaps_t gaps;
+
+    /* Should single containers on a workspace receive a border? */
+    smart_borders_t smart_borders;
+
+    /* Disable gaps if there is only one container on the workspace */
+    bool smart_gaps;
 };
 
 /**
@@ -304,6 +329,9 @@
     /** Enable verbose mode? Useful for debugging purposes. */
     bool verbose;
 
+    /** Defines the height of the bar in pixels. */
+    uint32_t bar_height;
+
     struct bar_colors {
         char *background;
         char *statusline;
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/include/config_directives.h ./include/config_directives.h
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/include/config_directives.h	2015-04-16 02:03:02.000000000 -0500
+++ ./include/config_directives.h	2015-06-20 00:55:28.000000000 -0500
@@ -40,6 +40,9 @@
 CFGFUN(font, const char *font);
 CFGFUN(exec, const char *exectype, const char *no_startup_id, const char *command);
 CFGFUN(for_window, const char *command);
+CFGFUN(gaps, const char *workspace, const char *type, const long value);
+CFGFUN(smart_borders, const char *enable);
+CFGFUN(smart_gaps, const char *enable);
 CFGFUN(floating_minimum_size, const long width, const long height);
 CFGFUN(floating_maximum_size, const long width, const long height);
 CFGFUN(default_orientation, const char *orientation);
@@ -51,8 +54,11 @@
 CFGFUN(force_xinerama, const char *value);
 CFGFUN(fake_outputs, const char *outputs);
 CFGFUN(force_display_urgency_hint, const long duration_ms);
+CFGFUN(focus_on_window_activation, const char *mode);
+CFGFUN(show_marks, const char *value);
 CFGFUN(hide_edge_borders, const char *borders);
 CFGFUN(assign, const char *workspace);
+CFGFUN(no_focus);
 CFGFUN(ipc_socket, const char *path);
 CFGFUN(restart_state, const char *path);
 CFGFUN(popup_during_fullscreen, const char *value);
@@ -73,6 +79,7 @@
 CFGFUN(bar_id, const char *bar_id);
 CFGFUN(bar_output, const char *output);
 CFGFUN(bar_verbose, const char *verbose);
+CFGFUN(bar_height, const long height);
 CFGFUN(bar_modifier, const char *modifier);
 CFGFUN(bar_wheel_up_cmd, const char *command);
 CFGFUN(bar_wheel_down_cmd, const char *command);
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/include/data.h ./include/data.h
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/include/data.h	2015-04-16 02:03:02.000000000 -0500
+++ ./include/data.h	2015-06-20 00:55:28.000000000 -0500
@@ -46,6 +46,7 @@
 typedef struct Match Match;
 typedef struct Assignment Assignment;
 typedef struct Window i3Window;
+typedef struct gaps_t gaps_t;
 
 /******************************************************************************
  * Helper types
@@ -74,6 +75,10 @@
                ADJ_UPPER_SCREEN_EDGE = (1 << 2),
                ADJ_LOWER_SCREEN_EDGE = (1 << 4) } adjacent_t;
 
+typedef enum { OFF,
+               ON,
+               NO_GAPS } smart_borders_t;
+
 enum {
     BIND_NONE = 0,
     BIND_SHIFT = XCB_MOD_MASK_SHIFT,     /* (1 << 0) */
@@ -115,6 +120,11 @@
     POINTER_WARPING_NONE = 1
 } warping_t;
 
+struct gaps_t {
+    int inner;
+    int outer;
+};
+
 /**
  * Stores a rectangle, for example the size of a window, the child window etc.
  * It needs to be packed so that the compiler will not add any padding bytes.
@@ -174,12 +184,13 @@
 };
 
 /**
- * Stores which workspace (by name or number) goes to which output.
+ * Stores which workspace (by name or number) goes to which output and its gaps config.
  *
  */
 struct Workspace_Assignment {
     char *name;
     char *output;
+    gaps_t gaps;
 
     TAILQ_ENTRY(Workspace_Assignment) ws_assignments;
 };
@@ -460,6 +471,7 @@
      *
      * A_COMMAND = run the specified command for the matching window
      * A_TO_WORKSPACE = assign the matching window to the specified workspace
+     * A_NO_FOCUS = don't focus matched window when it is managed
      *
      * While the type is a bitmask, only one value can be set at a time. It is
      * a bitmask to allow filtering for multiple types, for example in the
@@ -469,7 +481,8 @@
     enum {
         A_ANY = 0,
         A_COMMAND = (1 << 0),
-        A_TO_WORKSPACE = (1 << 1)
+        A_TO_WORKSPACE = (1 << 1),
+        A_NO_FOCUS = (1 << 2)
     } type;
 
     /** the criteria to check if a window matches */
@@ -526,6 +539,9 @@
      * workspace is not a named workspace (for named workspaces, num == -1) */
     int num;
 
+    /** Only applicable for containers of type CT_WORKSPACE. */
+    gaps_t gaps;
+
     struct Con *parent;
 
     struct Rect rect;
@@ -543,6 +559,8 @@
 
     /* user-definable mark to jump to this container later */
     char *mark;
+    /* cached to decide whether a redraw is needed */
+    bool mark_changed;
 
     double percent;
 
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/include/floating.h ./include/floating.h
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/include/floating.h	2015-04-16 02:03:02.000000000 -0500
+++ ./include/floating.h	2015-06-20 00:55:28.000000000 -0500
@@ -64,6 +64,12 @@
  */
 bool floating_maybe_reassign_ws(Con *con);
 
+/**
+ * Centers a floating con above the specified rect.
+ *
+ */
+void floating_center(Con *con, Rect rect);
+
 #if 0
 /**
  * Removes the floating client from its workspace and attaches it to the new
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/include/i3.h ./include/i3.h
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/include/i3.h	2015-04-16 02:03:02.000000000 -0500
+++ ./include/i3.h	2015-06-20 00:55:28.000000000 -0500
@@ -24,6 +24,9 @@
 #include "data.h"
 #include "xcb.h"
 
+/** Git commit identifier, from version.c */
+extern const char *i3_version;
+
 /** The original value of RLIMIT_CORE when i3 was started. We need to restore
  * this before starting any other process, since we set RLIMIT_CORE to
  * RLIM_INFINITY for i3 debugging versions. */
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/include/ipc.h ./include/ipc.h
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/include/ipc.h	2015-04-16 02:03:02.000000000 -0500
+++ ./include/ipc.h	2015-06-20 00:55:28.000000000 -0500
@@ -51,12 +51,6 @@
                               uint32_t message_type)
 
 /**
- * Emulates mkdir -p (creates any missing folders)
- *
- */
-bool mkdirp(const char *path);
-
-/**
  * Handler for activity on the listening socket, meaning that a new client
  * has just connected and we should accept() him. Sets up the event handler
  * for activity on the new connection and inserts the file descriptor into
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/include/libi3.h ./include/libi3.h
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/include/libi3.h	2015-04-16 02:03:02.000000000 -0500
+++ ./include/libi3.h	2015-06-20 00:55:28.000000000 -0500
@@ -434,3 +434,27 @@
  *
  */
 int logical_px(const int logical);
+
+/**
+ * This function resolves ~ in pathnames.
+ * It may resolve wildcards in the first part of the path, but if no match
+ * or multiple matches are found, it just returns a copy of path as given.
+ *
+ */
+char *resolve_tilde(const char *path);
+
+/**
+ * Get the path of the first configuration file found. If override_configpath
+ * is specified, that path is returned and saved for further calls. Otherwise,
+ * checks the home directory first, then the system directory first, always
+ * taking into account the XDG Base Directory Specification ($XDG_CONFIG_HOME,
+ * $XDG_CONFIG_DIRS)
+ *
+ */
+char *get_config_path(const char *override_configpath, bool use_system_paths);
+
+/**
+ * Emulates mkdir -p (creates any missing folders)
+ *
+ */
+bool mkdirp(const char *path);
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/include/render.h ./include/render.h
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/include/render.h	2015-04-16 02:03:02.000000000 -0500
+++ ./include/render.h	2015-06-20 00:55:28.000000000 -0500
@@ -18,7 +18,7 @@
  * updated in X11.
  *
  */
-void render_con(Con *con, bool render_fullscreen);
+void render_con(Con *con, bool render_fullscreen, bool already_inset);
 
 /*
  * Returns the height for the decorations
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/include/util.h ./include/util.h
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/include/util.h	2015-04-16 02:03:02.000000000 -0500
+++ ./include/util.h	2015-06-20 00:55:28.000000000 -0500
@@ -107,14 +107,6 @@
                  char *err_message);
 
 /**
- * This function resolves ~ in pathnames.
- * It may resolve wildcards in the first part of the path, but if no match
- * or multiple matches are found, it just returns a copy of path as given.
- *
- */
-char *resolve_tilde(const char *path);
-
-/**
  * Checks if the given path exists by calling stat().
  *
  */
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/libi3/get_config_path.c ./libi3/get_config_path.c
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/libi3/get_config_path.c	1969-12-31 18:00:00.000000000 -0600
+++ ./libi3/get_config_path.c	2015-06-20 00:55:28.000000000 -0500
@@ -0,0 +1,91 @@
+/*
+ * vim:ts=4:sw=4:expandtab
+ *
+ * i3 - an improved dynamic tiling window manager
+ * © 2009-2015 Michael Stapelberg and contributors (see also: LICENSE)
+ *
+ */
+#include "libi3.h"
+#include <stdlib.h>
+#include <string.h>
+#include <sys/stat.h>
+
+/*
+ * Checks if the given path exists by calling stat().
+ *
+ */
+static bool path_exists(const char *path) {
+    struct stat buf;
+    return (stat(path, &buf) == 0);
+}
+
+/*
+ * Get the path of the first configuration file found. If override_configpath
+ * is specified, that path is returned and saved for further calls. Otherwise,
+ * checks the home directory first, then the system directory first, always
+ * taking into account the XDG Base Directory Specification ($XDG_CONFIG_HOME,
+ * $XDG_CONFIG_DIRS)
+ *
+ */
+char *get_config_path(const char *override_configpath, bool use_system_paths) {
+    char *xdg_config_home, *xdg_config_dirs, *config_path;
+
+    static const char *saved_configpath = NULL;
+
+    if (override_configpath != NULL) {
+        saved_configpath = override_configpath;
+        return sstrdup(saved_configpath);
+    }
+
+    if (saved_configpath != NULL)
+        return sstrdup(saved_configpath);
+
+    /* 1: check the traditional path under the home directory */
+    config_path = resolve_tilde("~/.i3/config");
+    if (path_exists(config_path))
+        return config_path;
+    free(config_path);
+
+    /* 2: check for $XDG_CONFIG_HOME/i3/config */
+    if ((xdg_config_home = getenv("XDG_CONFIG_HOME")) == NULL)
+        xdg_config_home = "~/.config";
+
+    xdg_config_home = resolve_tilde(xdg_config_home);
+    sasprintf(&config_path, "%s/i3/config", xdg_config_home);
+    free(xdg_config_home);
+
+    if (path_exists(config_path))
+        return config_path;
+    free(config_path);
+
+    /* The below paths are considered system-level, and can be skipped if the
+     * caller only wants user-level configs. */
+    if (!use_system_paths)
+        return NULL;
+
+    /* 3: check the traditional path under /etc */
+    config_path = SYSCONFDIR "/i3/config";
+    if (path_exists(config_path))
+        return sstrdup(config_path);
+
+    /* 4: check for $XDG_CONFIG_DIRS/i3/config */
+    if ((xdg_config_dirs = getenv("XDG_CONFIG_DIRS")) == NULL)
+        xdg_config_dirs = "/etc/xdg";
+
+    char *buf = sstrdup(xdg_config_dirs);
+    char *tok = strtok(buf, ":");
+    while (tok != NULL) {
+        tok = resolve_tilde(tok);
+        sasprintf(&config_path, "%s/i3/config", tok);
+        free(tok);
+        if (path_exists(config_path)) {
+            free(buf);
+            return config_path;
+        }
+        free(config_path);
+        tok = strtok(NULL, ":");
+    }
+    free(buf);
+
+    return NULL;
+}
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/libi3/mkdirp.c ./libi3/mkdirp.c
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/libi3/mkdirp.c	1969-12-31 18:00:00.000000000 -0600
+++ ./libi3/mkdirp.c	2015-06-20 00:55:28.000000000 -0500
@@ -0,0 +1,38 @@
+#include "libi3.h"
+#include <errno.h>
+#include <stdlib.h>
+#include <string.h>
+#include <sys/stat.h>
+
+/*
+ * Emulates mkdir -p (creates any missing folders)
+ *
+ */
+bool mkdirp(const char *path) {
+    if (mkdir(path, S_IRWXU | S_IRGRP | S_IXGRP | S_IROTH | S_IXOTH) == 0)
+        return true;
+    if (errno != ENOENT) {
+        ELOG("mkdir(%s) failed: %s\n", path, strerror(errno));
+        return false;
+    }
+    char *copy = sstrdup(path);
+    /* strip trailing slashes, if any */
+    while (copy[strlen(copy) - 1] == '/')
+        copy[strlen(copy) - 1] = '\0';
+
+    char *sep = strrchr(copy, '/');
+    if (sep == NULL) {
+        if (copy != NULL) {
+            free(copy);
+            copy = NULL;
+        }
+        return false;
+    }
+    *sep = '\0';
+    bool result = false;
+    if (mkdirp(copy))
+        result = mkdirp(path);
+    free(copy);
+
+    return result;
+}
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/libi3/resolve_tilde.c ./libi3/resolve_tilde.c
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/libi3/resolve_tilde.c	1969-12-31 18:00:00.000000000 -0600
+++ ./libi3/resolve_tilde.c	2015-06-20 00:55:28.000000000 -0500
@@ -0,0 +1,45 @@
+/*
+ * vim:ts=4:sw=4:expandtab
+ *
+ * i3 - an improved dynamic tiling window manager
+ * © 2009-2015 Michael Stapelberg and contributors (see also: LICENSE)
+ *
+ */
+
+#include "libi3.h"
+#include <err.h>
+#include <glob.h>
+#include <stdlib.h>
+#include <string.h>
+
+/*
+ * This function resolves ~ in pathnames.
+ * It may resolve wildcards in the first part of the path, but if no match
+ * or multiple matches are found, it just returns a copy of path as given.
+ *
+ */
+char *resolve_tilde(const char *path) {
+    static glob_t globbuf;
+    char *head, *tail, *result;
+
+    tail = strchr(path, '/');
+    head = strndup(path, tail ? (size_t)(tail - path) : strlen(path));
+
+    int res = glob(head, GLOB_TILDE, NULL, &globbuf);
+    free(head);
+    /* no match, or many wildcard matches are bad */
+    if (res == GLOB_NOMATCH || globbuf.gl_pathc != 1)
+        result = sstrdup(path);
+    else if (res != 0) {
+        err(EXIT_FAILURE, "glob() failed");
+    } else {
+        head = globbuf.gl_pathv[0];
+        result = scalloc(strlen(head) + (tail ? strlen(tail) : 0) + 1);
+        strncpy(result, head, strlen(head));
+        if (tail)
+            strncat(result, tail, strlen(tail));
+    }
+    globfree(&globbuf);
+
+    return result;
+}
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/man/i3-config-wizard.1 ./man/i3-config-wizard.1
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/man/i3-config-wizard.1	2015-04-16 02:03:17.000000000 -0500
+++ ./man/i3-config-wizard.1	2015-06-20 00:55:52.000000000 -0500
@@ -1,13 +1,13 @@
 '\" t
 .\"     Title: i3-config-wizard
 .\"    Author: [see the "AUTHOR" section]
-.\" Generator: DocBook XSL Stylesheets v1.78.1 <http://docbook.sf.net/>
-.\"      Date: 04/16/2015
+.\" Generator: DocBook XSL Stylesheets v1.76.1 <http://docbook.sf.net/>
+.\"      Date: 06/20/2015
 .\"    Manual: i3 Manual
 .\"    Source: i3 4.10.2
 .\"  Language: English
 .\"
-.TH "I3\-CONFIG\-WIZARD" "1" "04/16/2015" "i3 4\&.10\&.2" "i3 Manual"
+.TH "I3\-CONFIG\-WIZARD" "1" "06/20/2015" "i3 4\&.10\&.2" "i3 Manual"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/man/i3-dmenu-desktop.1 ./man/i3-dmenu-desktop.1
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/man/i3-dmenu-desktop.1	2015-04-16 02:03:17.000000000 -0500
+++ ./man/i3-dmenu-desktop.1	2015-06-20 00:55:52.000000000 -0500
@@ -1,4 +1,4 @@
-.\" Automatically generated by Pod::Man 2.28 (Pod::Simple 3.29)
+.\" Automatically generated by Pod::Man 2.28 (Pod::Simple 3.28)
 .\"
 .\" Standard preamble:
 .\" ========================================================================
@@ -71,7 +71,7 @@
 .\" ========================================================================
 .\"
 .IX Title "I3-DMENU-DESKTOP 1"
-.TH I3-DMENU-DESKTOP 1 "2015-04-16" "perl v5.18.4" "User Contributed Perl Documentation"
+.TH I3-DMENU-DESKTOP 1 "2015-06-19" "perl v5.20.2" "User Contributed Perl Documentation"
 .\" For nroff, turn off justification.  Always turn off hyphenation; it makes
 .\" way too many mistakes in technical documents.
 .if n .ad l
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/man/i3-dump-log.1 ./man/i3-dump-log.1
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/man/i3-dump-log.1	2015-04-16 02:03:17.000000000 -0500
+++ ./man/i3-dump-log.1	2015-06-20 00:55:52.000000000 -0500
@@ -1,13 +1,13 @@
 '\" t
 .\"     Title: i3-dump-log
 .\"    Author: [see the "AUTHOR" section]
-.\" Generator: DocBook XSL Stylesheets v1.78.1 <http://docbook.sf.net/>
-.\"      Date: 04/16/2015
+.\" Generator: DocBook XSL Stylesheets v1.76.1 <http://docbook.sf.net/>
+.\"      Date: 06/20/2015
 .\"    Manual: i3 Manual
 .\"    Source: i3 4.10.2
 .\"  Language: English
 .\"
-.TH "I3\-DUMP\-LOG" "1" "04/16/2015" "i3 4\&.10\&.2" "i3 Manual"
+.TH "I3\-DUMP\-LOG" "1" "06/20/2015" "i3 4\&.10\&.2" "i3 Manual"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/man/i3-input.1 ./man/i3-input.1
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/man/i3-input.1	2015-04-16 02:03:17.000000000 -0500
+++ ./man/i3-input.1	2015-06-20 00:55:52.000000000 -0500
@@ -1,13 +1,13 @@
 '\" t
 .\"     Title: i3-input
 .\"    Author: [see the "AUTHOR" section]
-.\" Generator: DocBook XSL Stylesheets v1.78.1 <http://docbook.sf.net/>
-.\"      Date: 04/16/2015
+.\" Generator: DocBook XSL Stylesheets v1.76.1 <http://docbook.sf.net/>
+.\"      Date: 06/20/2015
 .\"    Manual: i3 Manual
 .\"    Source: i3 4.10.2
 .\"  Language: English
 .\"
-.TH "I3\-INPUT" "1" "04/16/2015" "i3 4\&.10\&.2" "i3 Manual"
+.TH "I3\-INPUT" "1" "06/20/2015" "i3 4\&.10\&.2" "i3 Manual"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/man/i3-migrate-config-to-v4.1 ./man/i3-migrate-config-to-v4.1
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/man/i3-migrate-config-to-v4.1	2015-04-16 02:03:17.000000000 -0500
+++ ./man/i3-migrate-config-to-v4.1	2015-06-20 00:55:52.000000000 -0500
@@ -1,13 +1,13 @@
 '\" t
 .\"     Title: i3-migrate-config-to-v4
 .\"    Author: [see the "AUTHOR" section]
-.\" Generator: DocBook XSL Stylesheets v1.78.1 <http://docbook.sf.net/>
-.\"      Date: 04/16/2015
+.\" Generator: DocBook XSL Stylesheets v1.76.1 <http://docbook.sf.net/>
+.\"      Date: 06/20/2015
 .\"    Manual: i3 Manual
 .\"    Source: i3 4.10.2
 .\"  Language: English
 .\"
-.TH "I3\-MIGRATE\-CONFIG\" "1" "04/16/2015" "i3 4\&.10\&.2" "i3 Manual"
+.TH "I3\-MIGRATE\-CONFIG\" "1" "06/20/2015" "i3 4\&.10\&.2" "i3 Manual"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/man/i3-msg.1 ./man/i3-msg.1
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/man/i3-msg.1	2015-04-16 02:03:17.000000000 -0500
+++ ./man/i3-msg.1	2015-06-20 00:55:52.000000000 -0500
@@ -1,13 +1,13 @@
 '\" t
 .\"     Title: i3-msg
 .\"    Author: [see the "AUTHOR" section]
-.\" Generator: DocBook XSL Stylesheets v1.78.1 <http://docbook.sf.net/>
-.\"      Date: 04/16/2015
+.\" Generator: DocBook XSL Stylesheets v1.76.1 <http://docbook.sf.net/>
+.\"      Date: 06/20/2015
 .\"    Manual: i3 Manual
 .\"    Source: i3 4.10.2
 .\"  Language: English
 .\"
-.TH "I3\-MSG" "1" "04/16/2015" "i3 4\&.10\&.2" "i3 Manual"
+.TH "I3\-MSG" "1" "06/20/2015" "i3 4\&.10\&.2" "i3 Manual"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/man/i3-nagbar.1 ./man/i3-nagbar.1
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/man/i3-nagbar.1	2015-04-16 02:03:17.000000000 -0500
+++ ./man/i3-nagbar.1	2015-06-20 00:55:52.000000000 -0500
@@ -1,13 +1,13 @@
 '\" t
 .\"     Title: i3-nagbar
 .\"    Author: [see the "AUTHOR" section]
-.\" Generator: DocBook XSL Stylesheets v1.78.1 <http://docbook.sf.net/>
-.\"      Date: 04/16/2015
+.\" Generator: DocBook XSL Stylesheets v1.76.1 <http://docbook.sf.net/>
+.\"      Date: 06/20/2015
 .\"    Manual: i3 Manual
 .\"    Source: i3 4.10.2
 .\"  Language: English
 .\"
-.TH "I3\-NAGBAR" "1" "04/16/2015" "i3 4\&.10\&.2" "i3 Manual"
+.TH "I3\-NAGBAR" "1" "06/20/2015" "i3 4\&.10\&.2" "i3 Manual"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/man/i3-save-tree.1 ./man/i3-save-tree.1
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/man/i3-save-tree.1	2015-04-16 02:03:17.000000000 -0500
+++ ./man/i3-save-tree.1	2015-06-20 00:55:52.000000000 -0500
@@ -1,4 +1,4 @@
-.\" Automatically generated by Pod::Man 2.28 (Pod::Simple 3.29)
+.\" Automatically generated by Pod::Man 2.28 (Pod::Simple 3.28)
 .\"
 .\" Standard preamble:
 .\" ========================================================================
@@ -71,7 +71,7 @@
 .\" ========================================================================
 .\"
 .IX Title "I3-SAVE-TREE 1"
-.TH I3-SAVE-TREE 1 "2015-04-16" "perl v5.18.4" "User Contributed Perl Documentation"
+.TH I3-SAVE-TREE 1 "2015-06-19" "perl v5.20.2" "User Contributed Perl Documentation"
 .\" For nroff, turn off justification.  Always turn off hyphenation; it makes
 .\" way too many mistakes in technical documents.
 .if n .ad l
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/man/i3-sensible-editor.1 ./man/i3-sensible-editor.1
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/man/i3-sensible-editor.1	2015-04-16 02:03:17.000000000 -0500
+++ ./man/i3-sensible-editor.1	2015-06-20 00:55:52.000000000 -0500
@@ -1,13 +1,13 @@
 '\" t
 .\"     Title: i3-sensible-editor
 .\"    Author: [see the "AUTHOR" section]
-.\" Generator: DocBook XSL Stylesheets v1.78.1 <http://docbook.sf.net/>
-.\"      Date: 04/16/2015
+.\" Generator: DocBook XSL Stylesheets v1.76.1 <http://docbook.sf.net/>
+.\"      Date: 06/20/2015
 .\"    Manual: i3 Manual
 .\"    Source: i3 4.10.2
 .\"  Language: English
 .\"
-.TH "I3\-SENSIBLE\-EDITOR" "1" "04/16/2015" "i3 4\&.10\&.2" "i3 Manual"
+.TH "I3\-SENSIBLE\-EDITOR" "1" "06/20/2015" "i3 4\&.10\&.2" "i3 Manual"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/man/i3-sensible-pager.1 ./man/i3-sensible-pager.1
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/man/i3-sensible-pager.1	2015-04-16 02:03:17.000000000 -0500
+++ ./man/i3-sensible-pager.1	2015-06-20 00:55:52.000000000 -0500
@@ -1,13 +1,13 @@
 '\" t
 .\"     Title: i3-sensible-pager
 .\"    Author: [see the "AUTHOR" section]
-.\" Generator: DocBook XSL Stylesheets v1.78.1 <http://docbook.sf.net/>
-.\"      Date: 04/16/2015
+.\" Generator: DocBook XSL Stylesheets v1.76.1 <http://docbook.sf.net/>
+.\"      Date: 06/20/2015
 .\"    Manual: i3 Manual
 .\"    Source: i3 4.10.2
 .\"  Language: English
 .\"
-.TH "I3\-SENSIBLE\-PAGER" "1" "04/16/2015" "i3 4\&.10\&.2" "i3 Manual"
+.TH "I3\-SENSIBLE\-PAGER" "1" "06/20/2015" "i3 4\&.10\&.2" "i3 Manual"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/man/i3-sensible-terminal.1 ./man/i3-sensible-terminal.1
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/man/i3-sensible-terminal.1	2015-04-16 02:03:17.000000000 -0500
+++ ./man/i3-sensible-terminal.1	2015-06-20 00:55:52.000000000 -0500
@@ -1,13 +1,13 @@
 '\" t
 .\"     Title: i3-sensible-terminal
 .\"    Author: [see the "AUTHOR" section]
-.\" Generator: DocBook XSL Stylesheets v1.78.1 <http://docbook.sf.net/>
-.\"      Date: 04/16/2015
+.\" Generator: DocBook XSL Stylesheets v1.76.1 <http://docbook.sf.net/>
+.\"      Date: 06/20/2015
 .\"    Manual: i3 Manual
 .\"    Source: i3 4.10.2
 .\"  Language: English
 .\"
-.TH "I3\-SENSIBLE\-TERMIN" "1" "04/16/2015" "i3 4\&.10\&.2" "i3 Manual"
+.TH "I3\-SENSIBLE\-TERMIN" "1" "06/20/2015" "i3 4\&.10\&.2" "i3 Manual"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/man/i3.1 ./man/i3.1
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/man/i3.1	2015-04-16 02:03:17.000000000 -0500
+++ ./man/i3.1	2015-06-20 00:55:52.000000000 -0500
@@ -1,13 +1,13 @@
 '\" t
 .\"     Title: i3
 .\"    Author: [see the "AUTHOR" section]
-.\" Generator: DocBook XSL Stylesheets v1.78.1 <http://docbook.sf.net/>
-.\"      Date: 04/16/2015
+.\" Generator: DocBook XSL Stylesheets v1.76.1 <http://docbook.sf.net/>
+.\"      Date: 06/20/2015
 .\"    Manual: i3 Manual
 .\"    Source: i3 4.10.2
 .\"  Language: English
 .\"
-.TH "I3" "1" "04/16/2015" "i3 4\&.10\&.2" "i3 Manual"
+.TH "I3" "1" "06/20/2015" "i3 4\&.10\&.2" "i3 Manual"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/man/i3bar.1 ./man/i3bar.1
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/man/i3bar.1	2015-04-16 02:03:17.000000000 -0500
+++ ./man/i3bar.1	2015-06-20 00:55:52.000000000 -0500
@@ -1,13 +1,13 @@
 '\" t
 .\"     Title: i3bar
 .\"    Author: [see the "AUTHORS" section]
-.\" Generator: DocBook XSL Stylesheets v1.78.1 <http://docbook.sf.net/>
-.\"      Date: 04/16/2015
+.\" Generator: DocBook XSL Stylesheets v1.76.1 <http://docbook.sf.net/>
+.\"      Date: 06/20/2015
 .\"    Manual: i3 Manual
 .\"    Source: i3 4.10.2
 .\"  Language: English
 .\"
-.TH "I3BAR" "1" "04/16/2015" "i3 4\&.10\&.2" "i3 Manual"
+.TH "I3BAR" "1" "06/20/2015" "i3 4\&.10\&.2" "i3 Manual"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/parser-specs/commands.spec ./parser-specs/commands.spec
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/parser-specs/commands.spec	2015-04-16 02:03:02.000000000 -0500
+++ ./parser-specs/commands.spec	2015-06-20 00:55:28.000000000 -0500
@@ -39,6 +39,7 @@
   'scratchpad' -> SCRATCHPAD
   'mode' -> MODE
   'bar' -> BAR
+  'gaps' -> GAPS
 
 state CRITERIA:
   ctype = 'class' -> CRITERION
@@ -85,6 +86,23 @@
   border_style = '1pixel'
     -> call cmd_border($border_style, "1")
 
+# gaps inner|outer [current] [plus|minus] <px>
+state GAPS:
+  type = 'inner', 'outer'
+      -> GAPS_WITH_TYPE
+
+state GAPS_WITH_TYPE:
+  scope = 'current', 'all'
+      -> GAPS_WITH_SCOPE
+
+state GAPS_WITH_SCOPE:
+  mode = 'plus', 'minus', 'set'
+      -> GAPS_WITH_MODE
+
+state GAPS_WITH_MODE:
+  value = word
+      -> call cmd_gaps($type, $scope, $mode, $value)
+
 state BORDER_WIDTH:
   end
     -> call cmd_border($border_style, "2")
@@ -189,10 +207,12 @@
   floating = 'enable', 'disable', 'toggle'
       -> call cmd_floating($floating)
 
-# mark <mark>
+# mark [--toggle] <mark>
 state MARK:
+  toggle = '--toggle'
+      ->
   mark = string
-      -> call cmd_mark($mark)
+      -> call cmd_mark($mark, $toggle)
 
 # unmark [mark]
 state UNMARK:
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/parser-specs/config.spec ./parser-specs/config.spec
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/parser-specs/config.spec	2015-04-16 02:03:02.000000000 -0500
+++ ./parser-specs/config.spec	2015-06-20 00:55:28.000000000 -0500
@@ -22,6 +22,9 @@
   'bar'                                    -> BARBRACE
   'font'                                   -> FONT
   'mode'                                   -> MODENAME
+  'gaps'                                   -> GAPS
+  'smart_borders'                          -> SMART_BORDERS
+  'smart_gaps'                             -> SMART_GAPS
   'floating_minimum_size'                  -> FLOATING_MINIMUM_SIZE_WIDTH
   'floating_maximum_size'                  -> FLOATING_MAXIMUM_SIZE_WIDTH
   'floating_modifier'                      -> FLOATING_MODIFIER
@@ -31,6 +34,7 @@
   'hide_edge_borders'                      -> HIDE_EDGE_BORDERS
   'for_window'                             -> FOR_WINDOW
   'assign'                                 -> ASSIGN
+  'no_focus'                               -> NO_FOCUS
   'focus_follows_mouse'                    -> FOCUS_FOLLOWS_MOUSE
   'mouse_warping'                          -> MOUSE_WARPING
   'force_focus_wrapping'                   -> FORCE_FOCUS_WRAPPING
@@ -38,6 +42,8 @@
   'workspace_auto_back_and_forth'          -> WORKSPACE_BACK_AND_FORTH
   'fake_outputs', 'fake-outputs'           -> FAKE_OUTPUTS
   'force_display_urgency_hint'             -> FORCE_DISPLAY_URGENCY_HINT
+  'focus_on_window_activation'             -> FOCUS_ON_WINDOW_ACTIVATION
+  'show_marks'                             -> SHOW_MARKS
   'workspace'                              -> WORKSPACE
   'ipc_socket', 'ipc-socket'               -> IPC_SOCKET
   'restart_state'                          -> RESTART_STATE
@@ -53,6 +59,28 @@
   line
       -> INITIAL
 
+# gaps inner|outer <px>
+state GAPS:
+  scope = 'inner', 'outer'
+      -> GAPS_WITH_SCOPE
+
+state GAPS_WITH_SCOPE:
+  value = number
+      -> call cfg_gaps($workspace, $scope, &value)
+
+# smart_borders true|false
+# smart_borders no_gaps
+state SMART_BORDERS:
+  enabled = '1', 'yes', 'true', 'on', 'enable', 'active'
+      -> call cfg_smart_borders($enabled)
+  enabled = 'no_gaps'
+      -> call cfg_smart_borders($enabled)
+
+# smart_gaps on|off
+state SMART_GAPS:
+  enabled = '1', 'yes', 'true', 'on', 'enable', 'active'
+      -> call cfg_smart_gaps($enabled)
+
 # floating_minimum_size <width> x <height>
 state FLOATING_MINIMUM_SIZE_WIDTH:
   width = number
@@ -148,6 +176,15 @@
   workspace = string
       -> call cfg_assign($workspace)
 
+# no_focus <criteria>
+state NO_FOCUS:
+  '['
+      -> call cfg_criteria_init(NO_FOCUS_END); CRITERIA
+
+state NO_FOCUS_END:
+  end
+      -> call cfg_no_focus()
+
 # Criteria: Used by for_window and assign.
 state CRITERIA:
   ctype = 'class'       -> CRITERION
@@ -204,20 +241,33 @@
   duration_ms = number
       -> FORCE_DISPLAY_URGENCY_HINT_MS
 
+# show_marks
+state SHOW_MARKS:
+  value = word
+      -> call cfg_show_marks($value)
+
 state FORCE_DISPLAY_URGENCY_HINT_MS:
   'ms'
       ->
   end
       -> call cfg_force_display_urgency_hint(&duration_ms)
 
+# focus_on_window_activation <smart|urgent|focus|none>
+state FOCUS_ON_WINDOW_ACTIVATION:
+  mode = word
+      -> call cfg_focus_on_window_activation($mode)
+
 # workspace <workspace> output <output>
+# workspace <workspace> gaps inner|outer <px>
 state WORKSPACE:
   workspace = word
-    -> WORKSPACE_OUTPUT
+    -> WORKSPACE_COMMAND
 
-state WORKSPACE_OUTPUT:
+state WORKSPACE_COMMAND:
   'output'
       -> WORKSPACE_OUTPUT_STR
+  'gaps'
+      -> GAPS
 
 state WORKSPACE_OUTPUT_STR:
   output = word
@@ -327,6 +377,8 @@
 state MODE_BINDING:
   release = '--release'
       ->
+  whole_window = '--whole-window'
+      ->
   modifiers = 'Mod1', 'Mod2', 'Mod3', 'Mod4', 'Mod5', 'Shift', 'Control', 'Ctrl', 'Mode_switch', '$mod'
       ->
   '+'
@@ -375,6 +427,7 @@
   'workspace_buttons'      -> BAR_WORKSPACE_BUTTONS
   'strip_workspace_numbers' -> BAR_STRIP_WORKSPACE_NUMBERS
   'verbose'                -> BAR_VERBOSE
+  'height'                 -> BAR_HEIGHT
   'colors'                 -> BAR_COLORS_BRACE
   '}'
       -> call cfg_bar_finish(); INITIAL
@@ -456,6 +509,10 @@
   value = word
       -> call cfg_bar_verbose($value); BAR
 
+state BAR_HEIGHT:
+  value = number
+      -> call cfg_bar_height(&value); BAR
+
 state BAR_COLORS_BRACE:
   end
       ->
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/click.c ./src/click.c
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/click.c	2015-04-16 02:03:02.000000000 -0500
+++ ./src/click.c	2015-06-20 00:55:28.000000000 -0500
@@ -180,6 +180,9 @@
     if (con->parent->type == CT_DOCKAREA)
         goto done;
 
+    const bool is_left_or_right_click = (event->detail == XCB_BUTTON_INDEX_1 ||
+                                         event->detail == XCB_BUTTON_INDEX_3);
+
     /* if the user has bound an action to this click, it should override the
      * default behavior. */
     if (dest == CLICK_DECORATION || dest == CLICK_INSIDE) {
@@ -278,7 +281,8 @@
             return 1;
         }
 
-        if (!in_stacked && dest == CLICK_DECORATION) {
+        if (!in_stacked && dest == CLICK_DECORATION &&
+            is_left_or_right_click) {
             /* try tiling resize, but continue if it doesn’t work */
             DLOG("tiling resize with fallback\n");
             if (tiling_resize(con, event, dest))
@@ -291,7 +295,7 @@
             return 1;
         }
 
-        if (dest == CLICK_BORDER) {
+        if (dest == CLICK_BORDER && is_left_or_right_click) {
             DLOG("floating resize due to border click\n");
             floating_resize_window(floatingcon, proportional, event);
             return 1;
@@ -299,7 +303,8 @@
 
         /* 6: dragging, if this was a click on a decoration (which did not lead
          * to a resize) */
-        if (!in_stacked && dest == CLICK_DECORATION) {
+        if (!in_stacked && dest == CLICK_DECORATION &&
+            (event->detail == XCB_BUTTON_INDEX_1)) {
             floating_drag_window(floatingcon, event);
             return 1;
         }
@@ -320,8 +325,7 @@
     }
     /* 8: otherwise, check for border/decoration clicks and resize */
     else if ((dest == CLICK_BORDER || dest == CLICK_DECORATION) &&
-             (event->detail == XCB_BUTTON_INDEX_1 ||
-              event->detail == XCB_BUTTON_INDEX_3)) {
+             is_left_or_right_click) {
         DLOG("Trying to resize (tiling)\n");
         tiling_resize(con, event, dest);
     }
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/commands.c ./src/commands.c
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/commands.c	2015-04-16 02:03:02.000000000 -0500
+++ ./src/commands.c	2015-06-20 00:55:28.000000000 -0500
@@ -903,7 +903,7 @@
     // is not executed yet and will be batched with append_layout’s
     // needs_tree_render after the parser finished. We should check if that is
     // necessary at all.
-    render_con(croot, false);
+    render_con(croot, false, false);
 
     restore_open_placeholder_windows(parent);
 
@@ -1037,28 +1037,48 @@
 }
 
 /*
- * Implementation of 'mark <mark>'
+ * Implementation of 'mark [--toggle] <mark>'
  *
  */
-void cmd_mark(I3_CMD, char *mark) {
-    DLOG("Clearing all windows which have that mark first\n");
+void cmd_mark(I3_CMD, char *mark, char *toggle) {
+    HANDLE_EMPTY_MATCH;
 
-    Con *con;
-    TAILQ_FOREACH(con, &all_cons, all_cons) {
-        if (con->mark && strcmp(con->mark, mark) == 0)
-            FREE(con->mark);
+    owindow *current = TAILQ_FIRST(&owindows);
+    if (current == NULL) {
+        ysuccess(false);
+        return;
     }
 
-    DLOG("marking window with str %s\n", mark);
-    owindow *current;
-
-    HANDLE_EMPTY_MATCH;
+    /* Marks must be unique, i.e., no two windows must have the same mark. */
+    if (current != TAILQ_LAST(&owindows, owindows_head)) {
+        yerror("A mark must not be put onto more than one window");
+        return;
+    }
 
-    TAILQ_FOREACH(current, &owindows, owindows) {
-        DLOG("matching: %p / %s\n", current->con, current->con->name);
+    DLOG("matching: %p / %s\n", current->con, current->con->name);
+    current->con->mark_changed = true;
+    if (toggle != NULL && current->con->mark && strcmp(current->con->mark, mark) == 0) {
+        DLOG("removing window mark %s\n", mark);
+        FREE(current->con->mark);
+    } else {
+        DLOG("marking window with str %s\n", mark);
+        FREE(current->con->mark);
         current->con->mark = sstrdup(mark);
     }
 
+    DLOG("Clearing all non-matched windows with this mark\n");
+    Con *con;
+    TAILQ_FOREACH(con, &all_cons, all_cons) {
+        /* Skip matched window, we took care of it already. */
+        if (current->con == con)
+            continue;
+
+        if (con->mark && strcmp(con->mark, mark) == 0) {
+            FREE(con->mark);
+            con->mark_changed = true;
+        }
+    }
+
     cmd_output->needs_tree_render = true;
     // XXX: default reply for now, make this a better reply
     ysuccess(true);
@@ -1072,14 +1092,20 @@
     if (mark == NULL) {
         Con *con;
         TAILQ_FOREACH(con, &all_cons, all_cons) {
+            if (con->mark == NULL)
+                continue;
+
             FREE(con->mark);
+            con->mark_changed = true;
         }
         DLOG("removed all window marks");
     } else {
         Con *con;
         TAILQ_FOREACH(con, &all_cons, all_cons) {
-            if (con->mark && strcmp(con->mark, mark) == 0)
+            if (con->mark && strcmp(con->mark, mark) == 0) {
                 FREE(con->mark);
+                con->mark_changed = true;
+            }
         }
         DLOG("removed window mark %s\n", mark);
     }
@@ -1746,25 +1772,18 @@
     }
 
     if (strcmp(method, "absolute") == 0) {
-        Rect *rect = &focused->parent->rect;
-
         DLOG("moving to absolute center\n");
-        rect->x = croot->rect.width / 2 - rect->width / 2;
-        rect->y = croot->rect.height / 2 - rect->height / 2;
+        floating_center(focused->parent, croot->rect);
 
         floating_maybe_reassign_ws(focused->parent);
         cmd_output->needs_tree_render = true;
     }
 
     if (strcmp(method, "position") == 0) {
-        Rect *wsrect = &con_get_workspace(focused)->rect;
-        Rect newrect = focused->parent->rect;
-
         DLOG("moving to center\n");
-        newrect.x = wsrect->width / 2 - newrect.width / 2;
-        newrect.y = wsrect->height / 2 - newrect.height / 2;
+        floating_center(focused->parent, con_get_workspace(focused)->rect);
 
-        floating_reposition(focused->parent, newrect);
+        cmd_output->needs_tree_render = true;
     }
 
     // XXX: default reply for now, make this a better reply
@@ -2058,3 +2077,65 @@
     // XXX: default reply for now, make this a better reply
     ysuccess(true);
 }
+
+/**
+ * Implementation of 'gaps inner|outer current|all set|plus|minus <px>'
+ *
+ */
+void cmd_gaps(I3_CMD, char *type, char *scope, char *mode, char *value) {
+#define CMD_GAPS(type, other)                                      \
+    int pixels = atoi(value);                                      \
+    Con *workspace = con_get_workspace(focused);                   \
+                                                                   \
+    int current_value = config.gaps.type;                          \
+    if (strcmp(scope, "current") == 0)                             \
+        current_value += workspace->gaps.type;                     \
+                                                                   \
+    bool reset = false;                                            \
+    if (!strcmp(mode, "plus"))                                     \
+        current_value += pixels;                                   \
+    else if (!strcmp(mode, "minus"))                               \
+        current_value -= pixels;                                   \
+    else if (!strcmp(mode, "set")) {                               \
+        current_value = pixels;                                    \
+        reset = true;                                              \
+    } else {                                                       \
+        ELOG("Invalid mode %s when changing gaps", mode);          \
+        ysuccess(false);                                           \
+        return;                                                    \
+    }                                                              \
+                                                                   \
+    if (current_value < 0)                                         \
+        current_value = 0;                                         \
+                                                                   \
+    if (!strcmp(scope, "all")) {                                   \
+        Con *output, *cur_ws = NULL;                               \
+        TAILQ_FOREACH(output, &(croot->nodes_head), nodes) {       \
+            Con *content = output_get_content(output);             \
+            TAILQ_FOREACH(cur_ws, &(content->nodes_head), nodes) { \
+                if (reset)                                         \
+                    cur_ws->gaps.type = 0;                         \
+                else if (current_value + cur_ws->gaps.type < 0)    \
+                    cur_ws->gaps.type = -current_value;            \
+            }                                                      \
+        }                                                          \
+                                                                   \
+        config.gaps.type = current_value;                          \
+    } else {                                                       \
+        workspace->gaps.type = current_value - config.gaps.type;   \
+    }
+
+    if (!strcmp(type, "inner")) {
+        CMD_GAPS(inner, outer);
+    } else if (!strcmp(type, "outer")) {
+        CMD_GAPS(outer, inner);
+    } else {
+        ELOG("Invalid type %s when changing gaps", type);
+        ysuccess(false);
+        return;
+    }
+
+    cmd_output->needs_tree_render = true;
+    // XXX: default reply for now, make this a better reply
+    ysuccess(true);
+}
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/con.c ./src/con.c
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/con.c	2015-04-16 02:03:02.000000000 -0500
+++ ./src/con.c	2015-06-20 00:55:28.000000000 -0500
@@ -514,6 +514,32 @@
     return children;
 }
 
+/**
+ * Returns the number of visible non-floating children of this container.
+ * For example, if the container contains a hsplit which has two children,
+ * this will return 2 instead of 1.
+ */
+int con_num_visible_children(Con *con) {
+    if (con == NULL)
+        return 0;
+
+    int children = 0;
+    Con *current = NULL;
+    TAILQ_FOREACH(current, &(con->nodes_head), nodes) {
+        /* Leaf nodes are a child. */
+        if (con_is_leaf(current))
+            children++;
+        /* Stacked and tabbed containers are only considered one child. */
+        else if (current->layout == L_TABBED || current->layout == L_STACKED)
+            children++;
+        /* Split containers need to be recursed. */
+        else if (current->layout == L_SPLITH || current->layout == L_SPLITV)
+            children += con_num_visible_children(current);
+    }
+
+    return children;
+}
+
 /*
  * Updates the percent attribute of the children of the given container. This
  * function needs to be called when a window is added or removed from a
@@ -736,6 +762,9 @@
         }
     }
 
+    /* Save the urgency state so that we can restore it. */
+    bool urgent = con->urgent;
+
     /* Save the current workspace. So we can call workspace_show() by the end
      * of this function. */
     Con *current_ws = con_get_workspace(focused);
@@ -843,7 +872,7 @@
     if (source_ws == current_ws)
         con_focus(con_descend_focused(focus_next));
 
-    /* If anything within the container is associated with a startup sequence,
+    /* 9. If anything within the container is associated with a startup sequence,
      * delete it so child windows won't be created on the old workspace. */
     struct Startup_Sequence *sequence;
     xcb_get_property_cookie_t cookie;
@@ -877,6 +906,12 @@
 
     CALL(parent, on_remove_child);
 
+    /* 10. If the container was marked urgent, move the urgency hint. */
+    if (urgent) {
+        workspace_update_urgent_flag(source_ws);
+        con_set_urgency(con, true);
+    }
+
     ipc_send_window_event("move", con);
 }
 
@@ -1134,6 +1169,11 @@
  *
  */
 Rect con_border_style_rect(Con *con) {
+    if ((config.smart_borders == ON && con_num_visible_children(con_get_workspace(con)) <= 1) || (config.smart_borders == NO_GAPS && calculate_effective_gaps(con).outer == 0)) {
+        if (!con_is_floating(con))
+            return (Rect){0, 0, 0, 0};
+    }
+
     adjacent_t borders_to_hide = ADJ_NONE;
     int border_width = con->current_border_width;
     DLOG("The border width for con is set to: %d\n", con->current_border_width);
@@ -1346,11 +1386,7 @@
          * with an orientation). Since we switched to splith/splitv layouts,
          * using the "default" layout (which "only" should happen when using
          * legacy configs) is using the last split layout (either splith or
-         * splitv) in order to still do the same thing.
-         *
-         * Starting from v4.6 though, we will nag users about using "layout
-         * default", and in v4.9 we will remove it entirely (with an
-         * appropriate i3-migrate-config mechanism). */
+         * splitv) in order to still do the same thing. */
         con->layout = con->last_split_layout;
         /* In case last_split_layout was not initialized… */
         if (con->layout == L_DEFAULT)
@@ -1729,3 +1765,38 @@
 
     return complete_buf;
 }
+
+/**
+ * Calculates the effective gap sizes for a container.
+ */
+gaps_t calculate_effective_gaps(Con *con) {
+    Con *workspace = con_get_workspace(con);
+    if (workspace == NULL || (config.smart_gaps && con_num_visible_children(workspace) <= 1))
+        return (gaps_t){0, 0};
+
+    gaps_t gaps = {
+        .inner = (workspace->gaps.inner + config.gaps.inner) / 2,
+        .outer = workspace->gaps.outer + config.gaps.outer};
+
+    /* Outer gaps are added on top of inner gaps. */
+    gaps.outer += 2 * gaps.inner;
+
+    return gaps;
+}
+
+/**
+ * Recursively check whether the (potential) parent container
+ * contains the (potential) child container.
+ */
+bool con_has_parent(Con *parent, Con *child) {
+    Con *current = NULL;
+    TAILQ_FOREACH(current, &(parent->nodes_head), nodes) {
+        if (current == child)
+            return true;
+
+        if (con_has_parent(current, child))
+            return true;
+    }
+
+    return false;
+}
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/config.c ./src/config.c
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/config.c	2015-04-16 02:03:02.000000000 -0500
+++ ./src/config.c	2015-06-20 00:55:28.000000000 -0500
@@ -40,80 +40,18 @@
 }
 
 /*
- * Get the path of the first configuration file found. If override_configpath
- * is specified, that path is returned and saved for further calls. Otherwise,
- * checks the home directory first, then the system directory first, always
- * taking into account the XDG Base Directory Specification ($XDG_CONFIG_HOME,
- * $XDG_CONFIG_DIRS)
- *
- */
-static char *get_config_path(const char *override_configpath) {
-    char *xdg_config_home, *xdg_config_dirs, *config_path;
-
-    static const char *saved_configpath = NULL;
-
-    if (override_configpath != NULL) {
-        saved_configpath = override_configpath;
-        return sstrdup(saved_configpath);
-    }
-
-    if (saved_configpath != NULL)
-        return sstrdup(saved_configpath);
-
-    /* 1: check the traditional path under the home directory */
-    config_path = resolve_tilde("~/.i3/config");
-    if (path_exists(config_path))
-        return config_path;
-    free(config_path);
-
-    /* 2: check for $XDG_CONFIG_HOME/i3/config */
-    if ((xdg_config_home = getenv("XDG_CONFIG_HOME")) == NULL)
-        xdg_config_home = "~/.config";
-
-    xdg_config_home = resolve_tilde(xdg_config_home);
-    sasprintf(&config_path, "%s/i3/config", xdg_config_home);
-    free(xdg_config_home);
-
-    if (path_exists(config_path))
-        return config_path;
-    free(config_path);
-
-    /* 3: check the traditional path under /etc */
-    config_path = SYSCONFDIR "/i3/config";
-    if (path_exists(config_path))
-        return sstrdup(config_path);
-
-    /* 4: check for $XDG_CONFIG_DIRS/i3/config */
-    if ((xdg_config_dirs = getenv("XDG_CONFIG_DIRS")) == NULL)
-        xdg_config_dirs = "/etc/xdg";
-
-    char *buf = sstrdup(xdg_config_dirs);
-    char *tok = strtok(buf, ":");
-    while (tok != NULL) {
-        tok = resolve_tilde(tok);
-        sasprintf(&config_path, "%s/i3/config", tok);
-        free(tok);
-        if (path_exists(config_path)) {
-            free(buf);
-            return config_path;
-        }
-        free(config_path);
-        tok = strtok(NULL, ":");
-    }
-    free(buf);
-
-    die("Unable to find the configuration file (looked at "
-        "~/.i3/config, $XDG_CONFIG_HOME/i3/config, " SYSCONFDIR "/i3/config and $XDG_CONFIG_DIRS/i3/config)");
-}
-
-/*
  * Finds the configuration file to use (either the one specified by
  * override_configpath), the user’s one or the system default) and calls
  * parse_file().
  *
  */
 bool parse_configuration(const char *override_configpath, bool use_nagbar) {
-    char *path = get_config_path(override_configpath);
+    char *path = get_config_path(override_configpath, true);
+    if (path == NULL) {
+        die("Unable to find the configuration file (looked at "
+            "~/.i3/config, $XDG_CONFIG_HOME/i3/config, " SYSCONFDIR "/i3/config and $XDG_CONFIG_DIRS/i3/config)");
+    }
+
     LOG("Parsing configfile %s\n", path);
     FREE(current_configpath);
     current_configpath = path;
@@ -252,6 +190,8 @@
     INIT_COLOR(config.bar.unfocused, "#333333", "#222222", "#888888", "#000000");
     INIT_COLOR(config.bar.urgent, "#2f343a", "#900000", "#ffffff", "#000000");
 
+    config.show_marks = true;
+
     config.default_border = BS_NORMAL;
     config.default_floating_border = BS_NORMAL;
     config.default_border_width = logical_px(2);
@@ -259,6 +199,9 @@
     /* Set default_orientation to NO_ORIENTATION for auto orientation. */
     config.default_orientation = NO_ORIENTATION;
 
+    config.gaps.inner = 0;
+    config.gaps.outer = 0;
+
     /* Set default urgency reset delay to 500ms */
     if (config.workspace_urgency_timer == 0)
         config.workspace_urgency_timer = 0.5;
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/config_directives.c ./src/config_directives.c
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/config_directives.c	2015-04-16 02:03:02.000000000 -0500
+++ ./src/config_directives.c	2015-06-20 00:55:28.000000000 -0500
@@ -219,6 +219,59 @@
     TAILQ_INSERT_TAIL(&assignments, assignment, assignments);
 }
 
+void create_gaps_assignment(const char *workspace, bool inner, const long value) {
+    DLOG("Setting gaps for workspace %s", workspace);
+
+    struct Workspace_Assignment *assignment;
+    TAILQ_FOREACH(assignment, &ws_assignments, ws_assignments) {
+        if (strcasecmp(assignment->name, workspace) == 0) {
+            if (inner)
+                assignment->gaps.inner = value;
+            else
+                assignment->gaps.outer = value;
+
+            return;
+        }
+    }
+
+    // Assignment does not yet exist, let's create it.
+    assignment = scalloc(sizeof(struct Workspace_Assignment));
+    assignment->name = sstrdup(workspace);
+    assignment->output = NULL;
+    if (inner)
+        assignment->gaps.inner = value;
+    else
+        assignment->gaps.outer = value;
+    TAILQ_INSERT_TAIL(&ws_assignments, assignment, ws_assignments);
+}
+
+CFGFUN(gaps, const char *workspace, const char *scope, const long value) {
+    if (!strcmp(scope, "inner")) {
+        if (workspace == NULL)
+            config.gaps.inner = value;
+        else
+            create_gaps_assignment(workspace, true, value - config.gaps.inner);
+    } else if (!strcmp(scope, "outer")) {
+        if (workspace == NULL)
+            config.gaps.outer = value;
+        else
+            create_gaps_assignment(workspace, false, value - config.gaps.outer);
+    } else {
+        ELOG("Invalid command, cannot process scope %s", scope);
+    }
+}
+
+CFGFUN(smart_borders, const char *enable) {
+    if (!strcmp(enable, "no_gaps"))
+        config.smart_borders = NO_GAPS;
+    else
+        config.smart_borders = eval_boolstr(enable) ? ON : OFF;
+}
+
+CFGFUN(smart_gaps, const char *enable) {
+    config.smart_gaps = eval_boolstr(enable);
+}
+
 CFGFUN(floating_minimum_size, const long width, const long height) {
     config.floating_minimum_width = width;
     config.floating_minimum_height = height;
@@ -329,6 +382,27 @@
     config.workspace_urgency_timer = duration_ms / 1000.0;
 }
 
+CFGFUN(focus_on_window_activation, const char *mode) {
+    if (strcmp(mode, "smart") == 0)
+        config.focus_on_window_activation = FOWA_SMART;
+    else if (strcmp(mode, "urgent") == 0)
+        config.focus_on_window_activation = FOWA_URGENT;
+    else if (strcmp(mode, "focus") == 0)
+        config.focus_on_window_activation = FOWA_FOCUS;
+    else if (strcmp(mode, "none") == 0)
+        config.focus_on_window_activation = FOWA_NONE;
+    else {
+        ELOG("Unknown focus_on_window_activation mode \"%s\", ignoring it.\n", mode);
+        return;
+    }
+
+    DLOG("Set new focus_on_window_activation mode = %i", config.focus_on_window_activation);
+}
+
+CFGFUN(show_marks, const char *value) {
+    config.show_marks = eval_boolstr(value);
+}
+
 CFGFUN(workspace, const char *workspace, const char *output) {
     DLOG("Assigning workspace \"%s\" to output \"%s\"\n", workspace, output);
     /* Check for earlier assignments of the same workspace so that we
@@ -338,8 +412,9 @@
     bool duplicate = false;
     TAILQ_FOREACH(assignment, &ws_assignments, ws_assignments) {
         if (strcasecmp(assignment->name, workspace) == 0) {
-            ELOG("You have a duplicate workspace assignment for workspace \"%s\"\n",
-                 workspace);
+            if (assignment->output != NULL)
+                ELOG("You have a duplicate workspace assignment for workspace \"%s\"\n", workspace);
+
             assignment->output = sstrdup(output);
             duplicate = true;
         }
@@ -410,6 +485,19 @@
     TAILQ_INSERT_TAIL(&assignments, assignment, assignments);
 }
 
+CFGFUN(no_focus) {
+    if (match_is_empty(current_match)) {
+        ELOG("Match is empty, ignoring this assignment\n");
+        return;
+    }
+
+    DLOG("new assignment, using above criteria, to ignore focus on manage");
+    Assignment *assignment = scalloc(sizeof(Assignment));
+    match_copy(&(assignment->match), current_match);
+    assignment->type = A_NO_FOCUS;
+    TAILQ_INSERT_TAIL(&assignments, assignment, assignments);
+}
+
 /*******************************************************************************
  * Bar configuration (i3bar)
  ******************************************************************************/
@@ -449,6 +537,10 @@
     current_bar.verbose = eval_boolstr(verbose);
 }
 
+CFGFUN(bar_height, const long height) {
+    current_bar.bar_height = (uint32_t)height;
+}
+
 CFGFUN(bar_modifier, const char *modifier) {
     if (strcmp(modifier, "Mod1") == 0)
         current_bar.modifier = M_MOD1;
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/config_parser.c ./src/config_parser.c
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/config_parser.c	2015-04-16 02:03:02.000000000 -0500
+++ ./src/config_parser.c	2015-06-20 00:55:28.000000000 -0500
@@ -996,7 +996,7 @@
     check_for_duplicate_bindings(context);
 
     if (use_nagbar && (context->has_errors || context->has_warnings)) {
-        ELOG("FYI: You are using i3 version " I3_VERSION "\n");
+        ELOG("FYI: You are using i3 version %s\n", i3_version);
         if (version == 3)
             ELOG("Please convert your configfile first, then fix any remaining errors (see above).\n");
 
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/floating.c ./src/floating.c
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/floating.c	2015-04-16 02:03:02.000000000 -0500
+++ ./src/floating.c	2015-06-20 00:55:28.000000000 -0500
@@ -246,12 +246,10 @@
         if (con->window && con->window->leader != XCB_NONE &&
             (leader = con_by_window_id(con->window->leader)) != NULL) {
             DLOG("Centering above leader\n");
-            nc->rect.x = leader->rect.x + (leader->rect.width / 2) - (nc->rect.width / 2);
-            nc->rect.y = leader->rect.y + (leader->rect.height / 2) - (nc->rect.height / 2);
+            floating_center(nc, leader->rect);
         } else {
             /* center the window on workspace as fallback */
-            nc->rect.x = ws->rect.x + (ws->rect.width / 2) - (nc->rect.width / 2);
-            nc->rect.y = ws->rect.y + (ws->rect.height / 2) - (nc->rect.height / 2);
+            floating_center(nc, ws->rect);
         }
     }
 
@@ -290,8 +288,8 @@
     TAILQ_INSERT_TAIL(&(nc->focus_head), con, focused);
 
     /* render the cons to get initial window_rect correct */
-    render_con(nc, false);
-    render_con(con, false);
+    render_con(nc, false, true);
+    render_con(con, false, true);
 
     if (set_focus)
         con_focus(con);
@@ -310,8 +308,7 @@
     }
 
     ELOG("No output found at destination coordinates, centering floating window on current ws\n");
-    nc->rect.x = ws->rect.x + (ws->rect.width / 2) - (nc->rect.width / 2);
-    nc->rect.y = ws->rect.y + (ws->rect.height / 2) - (nc->rect.height / 2);
+    floating_center(nc, ws->rect);
 
     ipc_send_window_event("floating", con);
 }
@@ -420,6 +417,15 @@
     return true;
 }
 
+/*
+ * Centers a floating con above the specified rect.
+ *
+ */
+void floating_center(Con *con, Rect rect) {
+    con->rect.x = rect.x + (rect.width / 2) - (con->rect.width / 2);
+    con->rect.y = rect.y + (rect.height / 2) - (con->rect.height / 2);
+}
+
 DRAGGING_CB(drag_window_callback) {
     const struct xcb_button_press_event_t *event = extra;
 
@@ -427,7 +433,7 @@
     con->rect.x = old_rect->x + (new_x - event->root_x);
     con->rect.y = old_rect->y + (new_y - event->root_y);
 
-    render_con(con, false);
+    render_con(con, false, true);
     x_push_node(con);
     xcb_flush(conn);
 
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/handlers.c ./src/handlers.c
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/handlers.c	2015-04-16 02:03:02.000000000 -0500
+++ ./src/handlers.c	2015-06-20 00:55:28.000000000 -0500
@@ -743,16 +743,17 @@
             workspace_show(ws);
             con_focus(con);
         } else {
-            /* If the request is from an application, only focus if the
-             * workspace is visible. Otherwise set the urgency hint. */
-            if (workspace_is_visible(ws)) {
-                DLOG("Request to focus con on a visible workspace. Focusing con = %p\n", con);
+            /* Request is from an application. */
+
+            if (config.focus_on_window_activation == FOWA_FOCUS || (config.focus_on_window_activation == FOWA_SMART && workspace_is_visible(ws))) {
+                DLOG("Focusing con = %p\n", con);
                 workspace_show(ws);
                 con_focus(con);
-            } else {
-                DLOG("Request to focus con on a hidden workspace. Setting urgent con = %p\n", con);
+            } else if (config.focus_on_window_activation == FOWA_URGENT || (config.focus_on_window_activation == FOWA_SMART && !workspace_is_visible(ws))) {
+                DLOG("Marking con = %p urgent\n", con);
                 con_set_urgency(con, true);
-            }
+            } else
+                DLOG("Ignoring request for con = %p", con);
         }
 
         tree_render();
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/i3.mk ./src/i3.mk
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/i3.mk	2015-04-16 02:03:02.000000000 -0500
+++ ./src/i3.mk	2015-06-20 00:55:28.000000000 -0500
@@ -32,6 +32,10 @@
 	echo "[i3] PCH all.h"
 	$(CC) $(I3_CPPFLAGS) $(XCB_CPPFLAGS) $(CPPFLAGS) $(i3_CFLAGS) $(I3_CFLAGS) $(CFLAGS) -x c-header include/all.h -o include/all.h.pch
 
+src/version.o: src/version.c LAST_VERSION $(i3_HEADERS_DEP)
+	echo "[i3] CC $<"
+	$(CC) $(I3_CPPFLAGS) $(XCB_CPPFLAGS) $(CPPFLAGS) $(i3_CFLAGS) $(I3_CFLAGS) $(CFLAGS) $(PCH_FLAGS) -c -o $@ ${canonical_path}/$<
+
 src/%.o: src/%.c $(i3_HEADERS_DEP)
 	echo "[i3] CC $<"
 	$(CC) $(I3_CPPFLAGS) $(XCB_CPPFLAGS) $(CPPFLAGS) $(i3_CFLAGS) $(I3_CFLAGS) $(CFLAGS) $(PCH_FLAGS) -c -o $@ ${canonical_path}/$<
@@ -92,4 +96,4 @@
 
 clean-i3:
 	echo "[i3] Clean"
-	rm -f $(i3_OBJECTS) $(i3_SOURCES_GENERATED) $(i3_HEADERS_CMDPARSER) include/loglevels.h loglevels.tmp include/all.h.pch i3-command-parser.stamp i3-config-parser.stamp i3 test.config_parser test.commands_parser src/*.gcno src/cfgparse.* src/cmdparse.*
+	rm -f $(i3_OBJECTS) $(i3_SOURCES_GENERATED) $(i3_HEADERS_CMDPARSER) include/loglevels.h loglevels.tmp include/all.h.pch i3-command-parser.stamp i3-config-parser.stamp i3 test.config_parser test.commands_parser src/*.gcno src/cfgparse.* src/cmdparse.* LAST_VERSION
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/ipc.c ./src/ipc.c
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/ipc.c	2015-04-16 02:03:02.000000000 -0500
+++ ./src/ipc.c	2015-06-20 00:55:28.000000000 -0500
@@ -38,36 +38,6 @@
 }
 
 /*
- * Emulates mkdir -p (creates any missing folders)
- *
- */
-bool mkdirp(const char *path) {
-    if (mkdir(path, S_IRWXU | S_IRGRP | S_IXGRP | S_IROTH | S_IXOTH) == 0)
-        return true;
-    if (errno != ENOENT) {
-        ELOG("mkdir(%s) failed: %s\n", path, strerror(errno));
-        return false;
-    }
-    char *copy = sstrdup(path);
-    /* strip trailing slashes, if any */
-    while (copy[strlen(copy) - 1] == '/')
-        copy[strlen(copy) - 1] = '\0';
-
-    char *sep = strrchr(copy, '/');
-    if (sep == NULL) {
-        FREE(copy);
-        return false;
-    }
-    *sep = '\0';
-    bool result = false;
-    if (mkdirp(copy))
-        result = mkdirp(path);
-    free(copy);
-
-    return result;
-}
-
-/*
  * Sends the specified event to all IPC clients which are currently connected
  * and subscribed to this kind of event.
  *
@@ -151,6 +121,16 @@
     y(map_close);
 }
 
+static void dump_gaps(yajl_gen gen, const char *name, gaps_t gaps) {
+    ystr(name);
+    y(map_open);
+    ystr("inner");
+    y(integer, gaps.inner);
+    ystr("outer");
+    y(integer, gaps.outer);
+    y(map_close);
+}
+
 static void dump_binding(yajl_gen gen, Binding *bind) {
     y(map_open);
     ystr("input_code");
@@ -362,6 +342,8 @@
     if (con->type == CT_WORKSPACE) {
         ystr("num");
         y(integer, con->num);
+
+        dump_gaps(gen, "gaps", con->gaps);
     }
 
     ystr("window");
@@ -598,6 +580,11 @@
     YSTR_IF_SET(status_command);
     YSTR_IF_SET(font);
 
+    if (config->bar_height) {
+        ystr("bar_height");
+        y(integer, config->bar_height);
+    }
+
     if (config->separator_symbol) {
         ystr("separator_symbol");
         ystr(config->separator_symbol);
@@ -821,7 +808,7 @@
     y(integer, PATCH_VERSION);
 
     ystr("human_readable");
-    ystr(I3_VERSION);
+    ystr(i3_version);
 
     y(map_close);
 
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/load_layout.c ./src/load_layout.c
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/load_layout.c	2015-04-16 02:03:02.000000000 -0500
+++ ./src/load_layout.c	2015-06-20 00:55:28.000000000 -0500
@@ -22,6 +22,7 @@
 static char *last_key;
 static Con *json_node;
 static Con *to_focus;
+static bool parsing_gaps;
 static bool parsing_swallows;
 static bool parsing_rect;
 static bool parsing_deco_rect;
@@ -48,7 +49,7 @@
         match_init(current_swallow);
         TAILQ_INSERT_TAIL(&(json_node->swallow_head), current_swallow, matches);
     } else {
-        if (!parsing_rect && !parsing_deco_rect && !parsing_window_rect && !parsing_geometry) {
+        if (!parsing_rect && !parsing_deco_rect && !parsing_window_rect && !parsing_geometry && !parsing_gaps) {
             if (last_key && strcasecmp(last_key, "floating_nodes") == 0) {
                 DLOG("New floating_node\n");
                 Con *ws = con_get_workspace(json_node);
@@ -69,7 +70,7 @@
 
 static int json_end_map(void *ctx) {
     LOG("end of map\n");
-    if (!parsing_swallows && !parsing_rect && !parsing_deco_rect && !parsing_window_rect && !parsing_geometry) {
+    if (!parsing_swallows && !parsing_rect && !parsing_deco_rect && !parsing_window_rect && !parsing_geometry && !parsing_gaps) {
         /* Set a few default values to simplify manually crafted layout files. */
         if (json_node->layout == L_DEFAULT) {
             DLOG("Setting layout = L_SPLITH\n");
@@ -123,6 +124,7 @@
         json_node = json_node->parent;
     }
 
+    parsing_gaps = false;
     parsing_rect = false;
     parsing_deco_rect = false;
     parsing_window_rect = false;
@@ -172,6 +174,9 @@
     if (strcasecmp(last_key, "swallows") == 0)
         parsing_swallows = true;
 
+    if (strcasecmp(last_key, "gaps") == 0)
+        parsing_gaps = true;
+
     if (strcasecmp(last_key, "rect") == 0)
         parsing_rect = true;
 
@@ -398,6 +403,12 @@
             current_swallow->insert_where = val;
         }
     }
+    if (parsing_gaps) {
+        if (strcasecmp(last_key, "inner") == 0)
+            json_node->gaps.inner = val;
+        else if (strcasecmp(last_key, "outer") == 0)
+            json_node->gaps.outer = val;
+    }
 
     return 1;
 }
@@ -549,6 +560,7 @@
     yajl_status stat;
     json_node = con;
     to_focus = NULL;
+    parsing_gaps = false;
     parsing_swallows = false;
     parsing_rect = false;
     parsing_deco_rect = false;
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/main.c ./src/main.c
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/main.c	2015-04-16 02:03:02.000000000 -0500
+++ ./src/main.c	2015-06-20 00:55:28.000000000 -0500
@@ -188,7 +188,7 @@
 int main(int argc, char *argv[]) {
     /* Keep a symbol pointing to the I3_VERSION string constant so that we have
      * it in gdb backtraces. */
-    const char *i3_version __attribute__((unused)) = I3_VERSION;
+    const char *_i3_version __attribute__((unused)) = i3_version;
     char *override_configpath = NULL;
     bool autostart = true;
     char *layout_path = NULL;
@@ -261,11 +261,11 @@
                 only_check_config = true;
                 break;
             case 'v':
-                printf("i3 version " I3_VERSION " © 2009-2014 Michael Stapelberg and contributors\n");
+                printf("i3 version %s © 2009-2014 Michael Stapelberg and contributors\n", i3_version);
                 exit(EXIT_SUCCESS);
                 break;
             case 'm':
-                printf("Binary i3 version:  " I3_VERSION " © 2009-2014 Michael Stapelberg and contributors\n");
+                printf("Binary i3 version:  %s © 2009-2014 Michael Stapelberg and contributors\n", i3_version);
                 display_running_version();
                 exit(EXIT_SUCCESS);
                 break;
@@ -456,7 +456,7 @@
         free(cwd);
     }
 
-    LOG("i3 " I3_VERSION " starting\n");
+    LOG("i3 %s starting\n", i3_version);
 
     conn = xcb_connect(NULL, &conn_screen);
     if (xcb_connection_has_error(conn))
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/manage.c ./src/manage.c
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/manage.c	2015-04-16 02:03:02.000000000 -0500
+++ ./src/manage.c	2015-06-20 00:55:28.000000000 -0500
@@ -498,13 +498,13 @@
          * workspace at all. However, just calling render_con() on the
          * workspace isn’t enough either — it needs the rect. */
         ws->rect = ws->parent->rect;
-        render_con(ws, true);
+        render_con(ws, true, false);
         /* Disable setting focus, otherwise we’d move focus to an invisible
          * workspace, which we generally prevent (e.g. in
          * con_move_to_workspace). */
         set_focus = false;
     }
-    render_con(croot, false);
+    render_con(croot, false, false);
 
     /* Send an event about window creation */
     ipc_send_window_event("new", nc);
@@ -512,8 +512,10 @@
     /* Defer setting focus after the 'new' event has been sent to ensure the
      * proper window event sequence. */
     if (set_focus && !nc->window->doesnt_accept_focus && nc->mapped) {
-        DLOG("Now setting focus.\n");
-        con_focus(nc);
+        if (assignment_for(cwindow, A_NO_FOCUS) == NULL) {
+            DLOG("Now setting focus.\n");
+            con_focus(nc);
+        }
     }
 
     tree_render();
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/move.c ./src/move.c
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/move.c	2015-04-16 02:03:02.000000000 -0500
+++ ./src/move.c	2015-06-20 00:55:28.000000000 -0500
@@ -249,6 +249,14 @@
                         ? AFTER
                         : BEFORE);
         insert_con_into(con, target, position);
+    } else if (con->parent->parent->type == CT_WORKSPACE &&
+               con->parent->layout != L_DEFAULT &&
+               con_num_children(con->parent) == 1) {
+        /* Con is the lone child of a non-default layout container at the edge
+         * of the workspace. Treat it as though the workspace is its parent
+         * and move it to the next output. */
+        DLOG("Grandparent is workspace\n");
+        move_to_output_directed(con, direction);
     } else {
         DLOG("Moving into container above\n");
         position = (direction == D_UP || direction == D_LEFT ? BEFORE : AFTER);
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/randr.c ./src/randr.c
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/randr.c	2015-04-16 02:03:02.000000000 -0500
+++ ./src/randr.c	2015-06-20 00:55:28.000000000 -0500
@@ -356,7 +356,7 @@
     /* go through all assignments and move the existing workspaces to this output */
     struct Workspace_Assignment *assignment;
     TAILQ_FOREACH(assignment, &ws_assignments, ws_assignments) {
-        if (strcmp(assignment->output, output->name) != 0)
+        if (assignment->output == NULL || strcmp(assignment->output, output->name) != 0)
             continue;
 
         /* check if this workspace actually exists */
@@ -397,7 +397,7 @@
          * Then, we need to work with the "content" container, since we cannot
          * be sure that the workspace itself was rendered at all (in case it’s
          * invisible, it won’t be rendered). */
-        render_con(workspace_out, false);
+        render_con(workspace_out, false, true);
         Con *ws_out_content = output_get_content(workspace_out);
 
         Con *floating_con;
@@ -437,7 +437,7 @@
 
     /* otherwise, we create the first assigned ws for this output */
     TAILQ_FOREACH(assignment, &ws_assignments, ws_assignments) {
-        if (strcmp(assignment->output, output->name) != 0)
+        if (assignment->output == NULL || strcmp(assignment->output, output->name) != 0)
             continue;
 
         LOG("Initializing first assigned workspace \"%s\" for output \"%s\"\n",
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/render.c ./src/render.c
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/render.c	2015-04-16 02:03:02.000000000 -0500
+++ ./src/render.c	2015-06-20 00:55:28.000000000 -0500
@@ -71,7 +71,7 @@
     if (fullscreen) {
         fullscreen->rect = con->rect;
         x_raise_con(fullscreen);
-        render_con(fullscreen, true);
+        render_con(fullscreen, true, false);
         return;
     }
 
@@ -111,11 +111,54 @@
         DLOG("child at (%d, %d) with (%d x %d)\n",
              child->rect.x, child->rect.y, child->rect.width, child->rect.height);
         x_raise_con(child);
-        render_con(child, false);
+        render_con(child, false, child->type == CT_DOCKAREA);
     }
 }
 
 /*
+ * Decides whether the container should be inset.
+ */
+bool should_inset_con(Con *con, int children) {
+    /* Don't inset floating containers and workspaces. */
+    if (con->type == CT_FLOATING_CON || con->type == CT_WORKSPACE)
+        return false;
+
+    if (con_is_leaf(con))
+        return true;
+
+    return (con->layout == L_STACKED || con->layout == L_TABBED) && children > 0;
+}
+
+/*
+ * Returns whether the given container has an adjacent container in the
+ * specified direction. In other words, this returns true if and only if
+ * the container is not touching the edge of the screen in that direction.
+ */
+bool has_adjacent_container(Con *con, direction_t direction) {
+    Con *workspace = con_get_workspace(con);
+    Con *fullscreen = con_get_fullscreen_con(workspace, CF_GLOBAL);
+    if (fullscreen == NULL)
+        fullscreen = con_get_fullscreen_con(workspace, CF_OUTPUT);
+
+    /* If this container is fullscreen by itself, there's no adjacent container. */
+    if (con == fullscreen)
+        return false;
+
+    Con *first = con;
+    Con *second = NULL;
+    bool found_neighbor = resize_find_tiling_participants(&first, &second, direction);
+    if (!found_neighbor)
+        return false;
+
+    /* If we have an adjacent container and nothing is fullscreen, we consider it. */
+    if (fullscreen == NULL)
+        return true;
+
+    /* For fullscreen containers, only consider the adjacent container if it is also fullscreen. */
+    return con_has_parent(fullscreen, con) && con_has_parent(fullscreen, second);
+}
+
+/*
  * "Renders" the given container (and its children), meaning that all rects are
  * updated correctly. Note that this function does not call any xcb_*
  * functions, so the changes are completely done in memory only (and
@@ -123,7 +166,7 @@
  * updated in X11.
  *
  */
-void render_con(Con *con, bool render_fullscreen) {
+void render_con(Con *con, bool render_fullscreen, bool already_inset) {
     int children = con_num_children(con);
     DLOG("Rendering %snode %p / %s / layout %d / children %d\n",
          (render_fullscreen ? "fullscreen " : ""), con, con->name, con->layout,
@@ -142,6 +185,28 @@
         rect.height -= 2 * 2;
     }
 
+    bool should_inset = should_inset_con(con, children);
+    if (!already_inset && should_inset) {
+        gaps_t gaps = calculate_effective_gaps(con);
+        Rect inset = (Rect){
+            has_adjacent_container(con, D_LEFT) ? gaps.inner : gaps.outer,
+            has_adjacent_container(con, D_UP) ? gaps.inner : gaps.outer,
+            has_adjacent_container(con, D_RIGHT) ? -gaps.inner : -gaps.outer,
+            has_adjacent_container(con, D_DOWN) ? -gaps.inner : -gaps.outer};
+        inset.width -= inset.x;
+        inset.height -= inset.y;
+
+        rect = rect_add(rect, inset);
+        if (!render_fullscreen) {
+            con->rect = rect_add(con->rect, inset);
+            if (con->window) {
+                con->window_rect = rect_add(con->window_rect, inset);
+            }
+        }
+        inset.height = -inset.y;
+        con->deco_rect = rect_add(con->deco_rect, inset);
+    }
+
     int x = rect.x;
     int y = rect.y;
 
@@ -209,7 +274,7 @@
     if (fullscreen) {
         fullscreen->rect = rect;
         x_raise_con(fullscreen);
-        render_con(fullscreen, true);
+        render_con(fullscreen, true, false);
         /* Fullscreen containers are either global (underneath the CT_ROOT
          * container) or per-output (underneath the CT_CONTENT container). For
          * global fullscreen containers, we cannot abort rendering here yet,
@@ -257,7 +322,7 @@
         Con *output;
         if (!fullscreen) {
             TAILQ_FOREACH(output, &(con->nodes_head), nodes) {
-                render_con(output, false);
+                render_con(output, false, false);
             }
         }
 
@@ -326,7 +391,7 @@
                 DLOG("floating child at (%d,%d) with %d x %d\n",
                      child->rect.x, child->rect.y, child->rect.width, child->rect.height);
                 x_raise_con(child);
-                render_con(child, false);
+                render_con(child, false, true);
             }
         }
 
@@ -434,7 +499,7 @@
             DLOG("child at (%d, %d) with (%d x %d)\n",
                  child->rect.x, child->rect.y, child->rect.width, child->rect.height);
             x_raise_con(child);
-            render_con(child, false);
+            render_con(child, false, should_inset || already_inset);
             i++;
         }
 
@@ -447,7 +512,7 @@
              * that we have a non-leaf-container inside the stack. In that
              * case, the children of the non-leaf-container need to be raised
              * aswell. */
-                render_con(child, false);
+                render_con(child, false, true);
             }
 
             if (children != 1)
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/scratchpad.c ./src/scratchpad.c
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/scratchpad.c	2015-04-16 02:03:02.000000000 -0500
+++ ./src/scratchpad.c	2015-06-20 00:55:28.000000000 -0500
@@ -198,10 +198,7 @@
         con->rect.width = output->rect.width * 0.5;
         con->rect.height = output->rect.height * 0.75;
         floating_check_size(con);
-        con->rect.x = output->rect.x +
-                      ((output->rect.width / 2.0) - (con->rect.width / 2.0));
-        con->rect.y = output->rect.y +
-                      ((output->rect.height / 2.0) - (con->rect.height / 2.0));
+        floating_center(con, con_get_workspace(con)->rect);
     }
 
     /* Activate active workspace if window is from another workspace to ensure
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/tree.c ./src/tree.c
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/tree.c	2015-04-16 02:03:02.000000000 -0500
+++ ./src/tree.c	2015-06-20 00:55:28.000000000 -0500
@@ -523,7 +523,7 @@
     mark_unmapped(croot);
     croot->mapped = true;
 
-    render_con(croot, false);
+    render_con(croot, false, false);
 
     x_push_changes(croot);
     DLOG("-- END RENDERING --\n");
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/util.c ./src/util.c
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/util.c	2015-04-16 02:03:02.000000000 -0500
+++ ./src/util.c	2015-06-20 00:55:28.000000000 -0500
@@ -160,38 +160,6 @@
 }
 
 /*
- * This function resolves ~ in pathnames.
- * It may resolve wildcards in the first part of the path, but if no match
- * or multiple matches are found, it just returns a copy of path as given.
- *
- */
-char *resolve_tilde(const char *path) {
-    static glob_t globbuf;
-    char *head, *tail, *result;
-
-    tail = strchr(path, '/');
-    head = strndup(path, tail ? (size_t)(tail - path) : strlen(path));
-
-    int res = glob(head, GLOB_TILDE, NULL, &globbuf);
-    free(head);
-    /* no match, or many wildcard matches are bad */
-    if (res == GLOB_NOMATCH || globbuf.gl_pathc != 1)
-        result = sstrdup(path);
-    else if (res != 0) {
-        die("glob() failed");
-    } else {
-        head = globbuf.gl_pathv[0];
-        result = scalloc(strlen(head) + (tail ? strlen(tail) : 0) + 1);
-        strncpy(result, head, strlen(head));
-        if (tail)
-            strncat(result, tail, strlen(tail));
-    }
-    globfree(&globbuf);
-
-    return result;
-}
-
-/*
  * Checks if the given path exists by calling stat().
  *
  */
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/version.c ./src/version.c
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/version.c	1969-12-31 18:00:00.000000000 -0600
+++ ./src/version.c	2015-06-20 00:55:28.000000000 -0500
@@ -0,0 +1,11 @@
+/*
+ * vim:ts=4:sw=4:expandtab
+ *
+ * i3 - an improved dynamic tiling window manager
+ * © 2009-2015 Michael Stapelberg and contributors (see also: LICENSE)
+ *
+ * Stores the latest Git commit identifier so that it can be linked into i3
+ * and used dynamically without recompiling every object file.
+ *
+ */
+const char *i3_version = I3_VERSION;
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/workspace.c ./src/workspace.c
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/workspace.c	2015-04-16 02:03:02.000000000 -0500
+++ ./src/workspace.c	2015-06-20 00:55:28.000000000 -0500
@@ -54,6 +54,7 @@
         output = con_get_output(focused);
         /* look for assignments */
         struct Workspace_Assignment *assignment;
+        gaps_t gaps = (gaps_t){0, 0};
 
         /* We set workspace->num to the number if this workspace’s name begins
          * with a positive number. Otherwise it’s a named ws and num will be
@@ -62,12 +63,21 @@
 
         TAILQ_FOREACH(assignment, &ws_assignments, ws_assignments) {
             if (strcmp(assignment->name, num) == 0) {
-                DLOG("Found workspace name assignment to output \"%s\"\n", assignment->output);
-                GREP_FIRST(output, croot, !strcmp(child->name, assignment->output));
+                gaps = assignment->gaps;
+
+                if (assignment->output != NULL) {
+                    DLOG("Found workspace name assignment to output \"%s\"\n", assignment->output);
+                    GREP_FIRST(output, croot, !strcmp(child->name, assignment->output));
+                }
+
                 break;
             } else if (parsed_num != -1 && name_is_digits(assignment->name) && ws_name_to_number(assignment->name) == parsed_num) {
-                DLOG("Found workspace number assignment to output \"%s\"\n", assignment->output);
-                GREP_FIRST(output, croot, !strcmp(child->name, assignment->output));
+                gaps = assignment->gaps;
+
+                if (assignment->output != NULL) {
+                    DLOG("Found workspace number assignment to output \"%s\"\n", assignment->output);
+                    GREP_FIRST(output, croot, !strcmp(child->name, assignment->output));
+                }
             }
         }
 
@@ -86,6 +96,7 @@
         workspace->workspace_layout = config.default_layout;
         workspace->num = parsed_num;
         LOG("num = %d\n", workspace->num);
+        workspace->gaps = gaps;
 
         workspace->parent = content;
         _workspace_apply_default_orientation(workspace);
@@ -162,6 +173,7 @@
         struct Workspace_Assignment *assignment;
         TAILQ_FOREACH(assignment, &ws_assignments, ws_assignments) {
             if (strcmp(assignment->name, ws->name) != 0 ||
+                assignment->output == NULL ||
                 strcmp(assignment->output, output->name) == 0)
                 continue;
 
@@ -205,6 +217,15 @@
         }
         sasprintf(&(ws->name), "%d", c);
     }
+
+    struct Workspace_Assignment *assignment;
+    TAILQ_FOREACH(assignment, &ws_assignments, ws_assignments) {
+        if (strcmp(assignment->name, ws->name) == 0) {
+            ws->gaps = assignment->gaps;
+            break;
+        }
+    }
+
     con_attach(ws, content, false);
 
     sasprintf(&name, "[i3 con] workspace %s", ws->name);
@@ -846,6 +867,9 @@
     DLOG("Attaching new split %p to workspace %p\n", new, ws);
     con_attach(new, ws, false);
 
+    /* 5: fix the percentages */
+    con_fix_percent(ws);
+
     return new;
 }
 
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/x.c ./src/x.c
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/src/x.c	2015-04-16 02:03:02.000000000 -0500
+++ ./src/x.c	2015-06-20 00:55:28.000000000 -0500
@@ -363,6 +363,7 @@
         (con->window == NULL || !con->window->name_x_changed) &&
         !parent->pixmap_recreated &&
         !con->pixmap_recreated &&
+        !con->mark_changed &&
         memcmp(p, con->deco_render_params, sizeof(struct deco_render_params)) == 0) {
         free(p);
         goto copy_pixmaps;
@@ -381,6 +382,7 @@
 
     parent->pixmap_recreated = false;
     con->pixmap_recreated = false;
+    con->mark_changed = false;
 
     /* 2: draw the client.background, but only for the parts around the client_rect */
     if (con->window != NULL) {
@@ -531,10 +533,25 @@
     //DLOG("indent_level = %d, indent_mult = %d\n", indent_level, indent_mult);
     int indent_px = (indent_level * 5) * indent_mult;
 
+    int mark_width = 0;
+    if (config.show_marks && con->mark != NULL && (con->mark)[0] != '_') {
+        char *formatted_mark;
+        sasprintf(&formatted_mark, "[%s]", con->mark);
+        i3String *mark = i3string_from_utf8(formatted_mark);
+        FREE(formatted_mark);
+        mark_width = predict_text_width(mark);
+
+        draw_text(mark, parent->pixmap, parent->pm_gc,
+                  con->deco_rect.x + con->deco_rect.width - mark_width - logical_px(2),
+                  con->deco_rect.y + text_offset_y, mark_width);
+
+        I3STRING_FREE(mark);
+    }
+
     draw_text(win->name,
               parent->pixmap, parent->pm_gc,
-              con->deco_rect.x + 2 + indent_px, con->deco_rect.y + text_offset_y,
-              con->deco_rect.width - 2 - indent_px);
+              con->deco_rect.x + logical_px(2) + indent_px, con->deco_rect.y + text_offset_y,
+              con->deco_rect.width - logical_px(2) - indent_px - mark_width - logical_px(2));
 
 after_title:
     /* Since we don’t clip the text at all, it might in some cases be painted
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/testcases/Makefile.PL ./testcases/Makefile.PL
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/testcases/Makefile.PL	2015-04-16 02:03:02.000000000 -0500
+++ ./testcases/Makefile.PL	2015-06-20 00:55:28.000000000 -0500
@@ -8,8 +8,8 @@
     MIN_PERL_VERSION => '5.010000', # 5.10.0
     PREREQ_PM => {
         'AnyEvent'     => 0,
-        'AnyEvent::I3' => '0.15',
-        'X11::XCB'     => '0.09',
+        'AnyEvent::I3' => '0.16',
+        'X11::XCB'     => '0.12',
         'Inline'       => 0,
         'Inline::C'    => 0,
         'ExtUtils::PkgConfig' => 0,
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/testcases/complete-run.pl ./testcases/complete-run.pl
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/testcases/complete-run.pl	2015-04-16 02:03:02.000000000 -0500
+++ ./testcases/complete-run.pl	2015-06-20 00:55:28.000000000 -0500
@@ -8,7 +8,6 @@
 use utf8;
 # the following are modules which ship with Perl (>= 5.10):
 use Pod::Usage;
-use Cwd qw(abs_path);
 use File::Temp qw(tempfile tempdir);
 use Getopt::Long;
 use POSIX ();
@@ -17,8 +16,20 @@
 use TAP::Parser::Aggregator;
 use Time::HiRes qw(time);
 use IO::Handle;
+
+my $dirname;
+
+BEGIN {
+    use File::Basename;
+    use Cwd qw(abs_path);
+
+    # fileparse()[1] contains the directory portion of the specified path.
+    # See File::Basename(3p) for more details.
+    $dirname = (fileparse(abs_path($0)))[1];
+}
+
 # these are shipped with the testsuite
-use lib qw(lib);
+use lib $dirname . 'lib';
 use StartXServer;
 use StatusLine;
 use TestWorker;
@@ -70,6 +81,8 @@
 
 pod2usage(-verbose => 2, -exitcode => 0) if $help;
 
+chdir $dirname or die "Could not chdir into $dirname";
+
 # Check for missing executables
 my @binaries = qw(
                    ../i3
@@ -86,6 +99,16 @@
     die "$binary is not an executable" unless -x $binary;
 }
 
+if ($options{coverage}) {
+    qx(command -v lcov &> /dev/null);
+    die "Cannot find lcov needed for coverage testing." if $?;
+    qx(command -v genhtml &> /dev/null);
+    die "Cannot find genhtml needed for coverage testing." if $?;
+
+    # clean out the counters that may be left over from previous tests.
+    qx(lcov -d ../ --zerocounters &> /dev/null);
+}
+
 qx(Xephyr -help 2>&1);
 die "Xephyr was not found in your path. Please install Xephyr (xserver-xephyr on Debian)." if $?;
 
@@ -227,6 +250,17 @@
 
 END { cleanup() }
 
+if ($options{coverage}) {
+    print("\nGenerating test coverage report...\n");
+    qx(lcov -d ../ -b ../ --capture -o latest/i3-coverage.info);
+    qx(genhtml -o latest/i3-coverage latest/i3-coverage.info);
+    if ($?) {
+        print("Could not generate test coverage html. Did you compile i3 with test coverage support?\n");
+    } else {
+        print("Test coverage report generated in latest/i3-coverage\n");
+    }
+}
+
 exit ($aggregator->failed > 0);
 
 #
@@ -391,12 +425,15 @@
 
 =item B<--coverage-testing>
 
-Exits i3 cleanly (instead of kill -9) to make coverage testing work properly.
+Generates a test coverage report at C<latest/i3-coverage>. Exits i3 cleanly
+during tests (instead of kill -9) to make coverage testing work properly.
 
 =item B<--parallel>
 
-Number of Xephyr instances to start (if you don’t want to start num_cores * 2
+Number of Xephyr instances to start (if you don't want to start num_cores * 2
 instances for some reason).
 
   # Run all tests on a single Xephyr instance
   ./complete-run.pl -p 1
+
+=back
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/testcases/lib/i3test.pm ./testcases/lib/i3test.pm
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/testcases/lib/i3test.pm	2015-04-16 02:03:02.000000000 -0500
+++ ./testcases/lib/i3test.pm	2015-06-20 00:55:28.000000000 -0500
@@ -606,7 +606,7 @@
 
 =head2 cmd($command)
 
-Sends the specified command to i3.
+Sends the specified command to i3 and returns the output.
 
   my $ws = unused_workspace;
   cmd "workspace $ws";
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/testcases/t/113-urgent.t ./testcases/t/113-urgent.t
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/testcases/t/113-urgent.t	2015-04-16 02:03:02.000000000 -0500
+++ ./testcases/t/113-urgent.t	2015-06-20 00:55:28.000000000 -0500
@@ -307,6 +307,33 @@
     my $ws = get_ws($tmp);
     ok(!$ws->{urgent}, 'urgent flag not set on workspace');
 
+##############################################################################
+# Regression test for #1187: Urgency hint moves to new workspace when moving
+# a container to another workspace.
+##############################################################################
+
+    my $tmp_source = fresh_workspace;
+    my $tmp_target = fresh_workspace;
+    cmd 'workspace ' . $tmp_source;
+    sync_with_i3;
+    my $w1 = open_window;
+    my $w2 = open_window;
+    sync_with_i3;
+    cmd '[id="' . $w1->id . '"] focus';
+    sync_with_i3;
+    cmd 'mark urgent_con';
+    cmd '[id="' . $w2->id . '"] focus';
+    set_urgency($w1, 1, $type);
+    sync_with_i3;
+    cmd '[con_mark="urgent_con"] move container to workspace ' . $tmp_target;
+    sync_with_i3;
+    my $source_ws = get_ws($tmp_source);
+    my $target_ws = get_ws($tmp_target);
+    ok(!$source_ws->{urgent}, 'Source workspace is no longer marked urgent');
+    is($target_ws->{urgent}, 1, 'Target workspace is now marked urgent');
+
+##############################################################################
+
     exit_gracefully($pid);
 }
 
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/testcases/t/175-startup-notification.t ./testcases/t/175-startup-notification.t
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/testcases/t/175-startup-notification.t	2015-04-16 02:03:02.000000000 -0500
+++ ./testcases/t/175-startup-notification.t	2015-06-20 00:55:28.000000000 -0500
@@ -155,6 +155,11 @@
 
 is_num_children($first_ws, 3, 'three containers on the first workspace');
 
+# empty 'from' workspaces should not crash the renaming of startup sequences
+cmd "workspace $first_ws";
+cmd "rename workspace to temp";
+cmd "rename workspace to $first_ws";
+
 # Switch to the first workspace and move the focused window to the
 # second workspace.
 cmd "workspace $first_ws";
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/testcases/t/187-commands-parser.t ./testcases/t/187-commands-parser.t
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/testcases/t/187-commands-parser.t	2015-04-16 02:03:02.000000000 -0500
+++ ./testcases/t/187-commands-parser.t	2015-06-20 00:55:28.000000000 -0500
@@ -144,7 +144,7 @@
 ################################################################################
 
 is(parser_calls('unknown_literal'),
-   "ERROR: Expected one of these tokens: <end>, '[', 'move', 'exec', 'exit', 'restart', 'reload', 'shmlog', 'debuglog', 'border', 'layout', 'append_layout', 'workspace', 'focus', 'kill', 'open', 'fullscreen', 'split', 'floating', 'mark', 'unmark', 'resize', 'rename', 'nop', 'scratchpad', 'mode', 'bar'\n" .
+   "ERROR: Expected one of these tokens: <end>, '[', 'move', 'exec', 'exit', 'restart', 'reload', 'shmlog', 'debuglog', 'border', 'layout', 'append_layout', 'workspace', 'focus', 'kill', 'open', 'fullscreen', 'split', 'floating', 'mark', 'unmark', 'resize', 'rename', 'nop', 'scratchpad', 'mode', 'bar', 'gaps'\n" .
    "ERROR: Your command: unknown_literal\n" .
    "ERROR:               ^^^^^^^^^^^^^^^",
    'error for unknown literal ok');
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/testcases/t/201-config-parser.t ./testcases/t/201-config-parser.t
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/testcases/t/201-config-parser.t	2015-04-16 02:03:02.000000000 -0500
+++ ./testcases/t/201-config-parser.t	2015-06-20 00:55:28.000000000 -0500
@@ -45,6 +45,8 @@
     bindsym Mod1 + Shift +   x resize grow
     bindcode Mod1+44 resize shrink
     bindsym --release Mod1+x exec foo
+    bindsym --whole-window button3 nop
+    bindsym --release --whole-window button3 nop
 }
 EOT
 
@@ -53,11 +55,13 @@
 cfg_mode_binding(bindsym, Mod1,Shift, x, (null), (null), resize grow)
 cfg_mode_binding(bindcode, Mod1, 44, (null), (null), resize shrink)
 cfg_mode_binding(bindsym, Mod1, x, --release, (null), exec foo)
+cfg_mode_binding(bindsym, (null), button3, (null), --whole-window, nop)
+cfg_mode_binding(bindsym, (null), button3, --release, --whole-window, nop)
 EOT
 
 is(parser_calls($config),
    $expected,
-   'single number (move workspace 3) ok');
+   'mode bindings ok');
 
 ################################################################################
 # exec and exec_always
@@ -433,7 +437,7 @@
 EOT
 
 my $expected_all_tokens = <<'EOT';
-ERROR: CONFIG: Expected one of these tokens: <end>, '#', 'set', 'bindsym', 'bindcode', 'bind', 'bar', 'font', 'mode', 'floating_minimum_size', 'floating_maximum_size', 'floating_modifier', 'default_orientation', 'workspace_layout', 'new_window', 'new_float', 'hide_edge_borders', 'for_window', 'assign', 'focus_follows_mouse', 'mouse_warping', 'force_focus_wrapping', 'force_xinerama', 'force-xinerama', 'workspace_auto_back_and_forth', 'fake_outputs', 'fake-outputs', 'force_display_urgency_hint', 'workspace', 'ipc_socket', 'ipc-socket', 'restart_state', 'popup_during_fullscreen', 'exec_always', 'exec', 'client.background', 'client.focused_inactive', 'client.focused', 'client.unfocused', 'client.urgent', 'client.placeholder'
+ERROR: CONFIG: Expected one of these tokens: <end>, '#', 'set', 'bindsym', 'bindcode', 'bind', 'bar', 'font', 'mode', 'gaps', 'smart_borders', 'smart_gaps', 'floating_minimum_size', 'floating_maximum_size', 'floating_modifier', 'default_orientation', 'workspace_layout', 'new_window', 'new_float', 'hide_edge_borders', 'for_window', 'assign', 'no_focus', 'focus_follows_mouse', 'mouse_warping', 'force_focus_wrapping', 'force_xinerama', 'force-xinerama', 'workspace_auto_back_and_forth', 'fake_outputs', 'fake-outputs', 'force_display_urgency_hint', 'focus_on_window_activation', 'show_marks', 'workspace', 'ipc_socket', 'ipc-socket', 'restart_state', 'popup_during_fullscreen', 'exec_always', 'exec', 'client.background', 'client.focused_inactive', 'client.focused', 'client.unfocused', 'client.urgent', 'client.placeholder'
 EOT
 
 my $expected_end = <<'EOT';
@@ -647,7 +651,7 @@
 
 $expected = <<'EOT';
 cfg_bar_output(LVDS-1)
-ERROR: CONFIG: Expected one of these tokens: <end>, '#', 'set', 'i3bar_command', 'status_command', 'socket_path', 'mode', 'hidden_state', 'id', 'modifier', 'wheel_up_cmd', 'wheel_down_cmd', 'position', 'output', 'tray_output', 'font', 'separator_symbol', 'binding_mode_indicator', 'workspace_buttons', 'strip_workspace_numbers', 'verbose', 'colors', '}'
+ERROR: CONFIG: Expected one of these tokens: <end>, '#', 'set', 'i3bar_command', 'status_command', 'socket_path', 'mode', 'hidden_state', 'id', 'modifier', 'wheel_up_cmd', 'wheel_down_cmd', 'position', 'output', 'tray_output', 'font', 'separator_symbol', 'binding_mode_indicator', 'workspace_buttons', 'strip_workspace_numbers', 'verbose', 'height', 'colors', '}'
 ERROR: CONFIG: (in file <stdin>)
 ERROR: CONFIG: Line   1: bar {
 ERROR: CONFIG: Line   2:     output LVDS-1
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/testcases/t/210-mark-unmark.t ./testcases/t/210-mark-unmark.t
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/testcases/t/210-mark-unmark.t	2015-04-16 02:03:02.000000000 -0500
+++ ./testcases/t/210-mark-unmark.t	2015-06-20 00:55:28.000000000 -0500
@@ -16,11 +16,19 @@
 #
 # checks if mark and unmark work correctly
 use i3test;
+use List::Util qw(first);
 
 sub get_marks {
     return i3(get_socket_path())->get_marks->recv;
 }
 
+sub get_mark_for_window_on_workspace {
+    my ($ws, $con) = @_;
+
+    my $current = first { $_->{window} == $con->{id} } @{get_ws_content($ws)};
+    return $current->{mark};
+}
+
 ##############################################################
 # 1: check that there are no marks set yet
 ##############################################################
@@ -76,4 +84,78 @@
 
 is_deeply(get_marks(), [], 'all marks removed');
 
+##############################################################
+# 4: mark a con, use same mark to mark another con,
+#    check that only the latter is marked
+##############################################################
+
+my $first = open_window;
+my $second = open_window;
+
+cmd 'mark important';
+cmd 'focus left';
+cmd 'mark important';
+
+is(get_mark_for_window_on_workspace($tmp, $first), 'important', 'first container now has the mark');
+ok(!get_mark_for_window_on_workspace($tmp, $second), 'second container lost the mark');
+
+##############################################################
+# 5: mark a con, toggle the mark, check that the mark is gone
+##############################################################
+
+my $con = open_window;
+cmd 'mark important';
+cmd 'mark --toggle important';
+ok(!get_mark_for_window_on_workspace($tmp, $con), 'container no longer has the mark');
+
+##############################################################
+# 6: toggle a mark on an unmarked con, check it is marked
+##############################################################
+
+my $con = open_window;
+cmd 'mark --toggle important';
+is(get_mark_for_window_on_workspace($tmp, $con), 'important', 'container now has the mark');
+
+##############################################################
+# 7: mark a con, toggle a different mark, check it is marked
+#    with the new mark
+##############################################################
+
+my $con = open_window;
+cmd 'mark boring';
+cmd 'mark --toggle important';
+is(get_mark_for_window_on_workspace($tmp, $con), 'important', 'container has the most recent mark');
+
+##############################################################
+# 8: mark a con, toggle the mark on another con,
+#    check only the latter has the mark
+##############################################################
+
+my $first = open_window;
+my $second = open_window;
+
+cmd 'mark important';
+cmd 'focus left';
+cmd 'mark --toggle important';
+
+is(get_mark_for_window_on_workspace($tmp, $first), 'important', 'left container has the mark now');
+ok(!get_mark_for_window_on_workspace($tmp, $second), 'second containr no longer has the mark');
+
+##############################################################
+# 9: try to mark two cons with the same mark and check that
+#    it fails
+##############################################################
+
+my $first = open_window(wm_class => 'iamnotunique');
+my $second = open_window(wm_class => 'iamnotunique');
+
+my $result = cmd "[instance=iamnotunique] mark important";
+
+is($result->[0]->{success}, 0, 'command was unsuccessful');
+is($result->[0]->{error}, 'A mark must not be put onto more than one window', 'correct error is returned');
+ok(!get_mark_for_window_on_workspace($tmp, $first), 'first container is not marked');
+ok(!get_mark_for_window_on_workspace($tmp, $second), 'second containr is not marked');
+
+##############################################################
+
 done_testing;
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/testcases/t/235-wm-class-change-handler.t ./testcases/t/235-wm-class-change-handler.t
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/testcases/t/235-wm-class-change-handler.t	2015-04-16 02:03:02.000000000 -0500
+++ ./testcases/t/235-wm-class-change-handler.t	2015-06-20 00:55:28.000000000 -0500
@@ -31,16 +31,17 @@
 my $pid = launch_with_config($config);
 
 sub change_window_class {
-    my ($window, $class) = @_;
+    my ($window, $class, $length) = @_;
     my $atomname = $x->atom(name => 'WM_CLASS');
     my $atomtype = $x->atom(name => 'STRING');
+    $length ||= length($class) + 1;
     $x->change_property(
         PROP_MODE_REPLACE,
         $window->id,
         $atomname->id,
         $atomtype->id,
         8,
-        length($class) + 1,
+        $length,
         $class
     );
     sync_with_i3;
@@ -65,6 +66,13 @@
 is($con->{mark}, 'special_class_mark',
     'A `for_window` assignment should run for a match when the window changes class');
 
+change_window_class($win, "abcdefghijklmnopqrstuv\0abcd", 24);
+
+$con = @{get_ws_content($ws)}[0];
+
+is($con->{window_properties}->{class}, 'a',
+    'Non-null-terminated strings should be handled correctly');
+
 exit_gracefully($pid);
 
 done_testing;
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/testcases/t/240-focus-on-window-activation.t ./testcases/t/240-focus-on-window-activation.t
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/testcases/t/240-focus-on-window-activation.t	1969-12-31 18:00:00.000000000 -0600
+++ ./testcases/t/240-focus-on-window-activation.t	2015-06-20 00:55:28.000000000 -0500
@@ -0,0 +1,206 @@
+#!perl
+# vim:ts=4:sw=4:expandtab
+#
+# Please read the following documents before working on tests:
+# • http://build.i3wm.org/docs/testsuite.html
+#   (or docs/testsuite)
+#
+# • http://build.i3wm.org/docs/lib-i3test.html
+#   (alternatively: perldoc ./testcases/lib/i3test.pm)
+#
+# • http://build.i3wm.org/docs/ipc.html
+#   (or docs/ipc)
+#
+# • http://onyxneon.com/books/modern_perl/modern_perl_a4.pdf
+#   (unless you are already familiar with Perl)
+#
+# Tests for the focus_on_window_activation directive
+# Ticket: #1426
+use i3test i3_autostart => 0;
+use List::Util qw(first);
+
+sub send_net_active_window {
+    my ($id) = @_; 
+
+    my $msg = pack "CCSLLLLLLL",
+        X11::XCB::CLIENT_MESSAGE, # response_type
+        32, # format
+        0, # sequence
+        $id, # destination window
+        $x->atom(name => '_NET_ACTIVE_WINDOW')->id,
+        0, # source
+        0, 0, 0, 0;
+
+    $x->send_event(0, $x->get_root_window(), X11::XCB::EVENT_MASK_SUBSTRUCTURE_REDIRECT, $msg);
+}
+
+sub get_urgency_for_window_on_workspace {
+    my ($ws, $con) = @_;
+
+    my $current = first { $_->{window} == $con->{id} } @{get_ws_content($ws)};
+    return $current->{urgent};
+}
+
+#####################################################################
+# 1: If mode is set to 'urgent' and the target workspace is visible,
+#    check that the urgent flag is set and focus is not lost.
+#####################################################################
+
+my $config = <<EOT;
+# i3 config file (v4)
+font -misc-fixed-medium-r-normal--13-120-75-75-C-70-iso10646-1
+
+focus_on_window_activation urgent
+EOT
+
+my $pid = launch_with_config($config);
+
+my $ws = fresh_workspace;
+my $first = open_window;
+my $second = open_window;
+
+send_net_active_window($first->id);
+sync_with_i3;
+
+is($x->input_focus, $second->id, 'second window is still focused');
+is(get_urgency_for_window_on_workspace($ws, $first), 1, 'first window is marked urgent');
+
+exit_gracefully($pid);
+
+#####################################################################
+# 2: If mode is set to 'urgent' and the target workspace is not
+#    visible, check that the urgent flag is set and focus is not lost.
+#####################################################################
+
+my $config = <<EOT;
+# i3 config file (v4)
+font -misc-fixed-medium-r-normal--13-120-75-75-C-70-iso10646-1
+
+focus_on_window_activation urgent
+EOT
+
+my $pid = launch_with_config($config);
+
+my $ws1 = fresh_workspace;
+my $first = open_window;
+my $ws2 = fresh_workspace;
+my $second = open_window;
+
+send_net_active_window($first->id);
+sync_with_i3;
+
+is(focused_ws(), $ws2, 'second workspace is still focused');
+is($x->input_focus, $second->id, 'second window is still focused');
+is(get_urgency_for_window_on_workspace($ws1, $first), 1, 'first window is marked urgent');
+
+exit_gracefully($pid);
+
+#####################################################################
+# 3: If mode is set to 'focus' and the target workspace is visible,
+#    check that the focus is switched.
+#####################################################################
+
+my $config = <<EOT;
+# i3 config file (v4)
+font -misc-fixed-medium-r-normal--13-120-75-75-C-70-iso10646-1
+
+focus_on_window_activation focus
+EOT
+
+my $pid = launch_with_config($config);
+
+my $ws = fresh_workspace;
+my $first = open_window;
+my $second = open_window;
+
+send_net_active_window($first->id);
+sync_with_i3;
+
+is($x->input_focus, $first->id, 'first window is now focused');
+ok(!get_urgency_for_window_on_workspace($ws, $first), 'first window is not marked urgent');
+
+exit_gracefully($pid);
+
+#####################################################################
+# 4: If mode is set to 'focus' and the target workspace is not
+#    visible, check that the focus switched.
+#####################################################################
+
+my $config = <<EOT;
+# i3 config file (v4)
+font -misc-fixed-medium-r-normal--13-120-75-75-C-70-iso10646-1
+
+focus_on_window_activation focus
+EOT
+
+my $pid = launch_with_config($config);
+
+my $ws1 = fresh_workspace;
+my $first = open_window;
+my $ws2 = fresh_workspace;
+my $second = open_window;
+
+send_net_active_window($first->id);
+sync_with_i3;
+
+is(focused_ws(), $ws1, 'first workspace is now focused');
+is($x->input_focus, $first->id, 'first window is now focused');
+ok(!get_urgency_for_window_on_workspace($ws1, $first), 'first window is not marked urgent');
+
+exit_gracefully($pid);
+
+#####################################################################
+# 5: If mode is set to 'none' and the target workspace is visible,
+#    check that nothing happens.
+#####################################################################
+
+my $config = <<EOT;
+# i3 config file (v4)
+font -misc-fixed-medium-r-normal--13-120-75-75-C-70-iso10646-1
+
+focus_on_window_activation none
+EOT
+
+my $pid = launch_with_config($config);
+
+my $ws = fresh_workspace;
+my $first = open_window;
+my $second = open_window;
+
+send_net_active_window($first->id);
+sync_with_i3;
+
+is($x->input_focus, $second->id, 'second window is still focused');
+ok(!get_urgency_for_window_on_workspace($ws, $first), 'first window is not marked urgent');
+
+exit_gracefully($pid);
+
+#####################################################################
+# 6: If mode is set to 'none' and the target workspace is not
+#    visible, check that nothing happens.
+#####################################################################
+
+my $config = <<EOT;
+# i3 config file (v4)
+font -misc-fixed-medium-r-normal--13-120-75-75-C-70-iso10646-1
+
+focus_on_window_activation none
+EOT
+
+my $pid = launch_with_config($config);
+
+my $ws1 = fresh_workspace;
+my $first = open_window;
+my $ws2 = fresh_workspace;
+my $second = open_window;
+
+send_net_active_window($first->id);
+sync_with_i3;
+
+is(focused_ws(), $ws2, 'second workspace is still focused');
+is($x->input_focus, $second->id, 'second window is still focused');
+ok(!get_urgency_for_window_on_workspace($ws1, $first), 'first window is not marked urgent');
+
+exit_gracefully($pid);
+
+done_testing;
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/testcases/t/240-tabbed-floating-disable-crash.t ./testcases/t/240-tabbed-floating-disable-crash.t
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/testcases/t/240-tabbed-floating-disable-crash.t	1969-12-31 18:00:00.000000000 -0600
+++ ./testcases/t/240-tabbed-floating-disable-crash.t	2015-06-20 00:55:28.000000000 -0500
@@ -0,0 +1,44 @@
+#!perl
+# vim:ts=4:sw=4:expandtab
+#
+# Please read the following documents before working on tests:
+# • http://build.i3wm.org/docs/testsuite.html
+#   (or docs/testsuite)
+#
+# • http://build.i3wm.org/docs/lib-i3test.html
+#   (alternatively: perldoc ./testcases/lib/i3test.pm)
+#
+# • http://build.i3wm.org/docs/ipc.html
+#   (or docs/ipc)
+#
+# • http://onyxneon.com/books/modern_perl/modern_perl_a4.pdf
+#   (unless you are already familiar with Perl)
+#
+# Verifies that i3 does not crash when floating and then unfloating an
+# unfocused window within a tabbed container.
+# Ticket: #1484
+# Bug still in: 4.9.1-124-g856e1f9
+use i3test i3_autostart => 0;
+
+my $config = <<EOT;
+# i3 config file (v4)
+font -misc-fixed-medium-r-normal--13-120-75-75-C-70-iso10646-1
+workspace_layout tabbed
+EOT
+
+my $pid = launch_with_config($config);
+
+open_window;
+open_window;
+
+# Mark the second window, then focus the workspace.
+cmd 'mark foo, focus parent, focus parent';
+
+# Float and unfloat the marked window (without it being focused).
+cmd '[con_mark=foo] floating enable, floating disable';
+
+does_i3_live;
+
+exit_gracefully($pid);
+
+done_testing;
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/testcases/t/241-consistent-center.t ./testcases/t/241-consistent-center.t
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/testcases/t/241-consistent-center.t	1969-12-31 18:00:00.000000000 -0600
+++ ./testcases/t/241-consistent-center.t	2015-06-20 00:55:28.000000000 -0500
@@ -0,0 +1,106 @@
+#!perl
+# vim:ts=4:sw=4:expandtab
+#
+# Please read the following documents before working on tests:
+# • http://build.i3wm.org/docs/testsuite.html
+#   (or docs/testsuite)
+#
+# • http://build.i3wm.org/docs/lib-i3test.html
+#   (alternatively: perldoc ./testcases/lib/i3test.pm)
+#
+# • http://build.i3wm.org/docs/ipc.html
+#   (or docs/ipc)
+#
+# • http://onyxneon.com/books/modern_perl/modern_perl_a4.pdf
+#   (unless you are already familiar with Perl)
+#
+# Verifies that most of i3's centering methods produce consistent results.
+# Decorations are disabled to avoid floating_enable's logic which shifts
+# windows upwards dependent on their decoration height.
+#
+use i3test i3_autostart => 0;
+
+my $config = <<EOT;
+# i3 config file (v4)
+font -misc-fixed-medium-r-normal--13-120-75-75-C-70-iso10646-1
+
+new_window none
+new_float none
+EOT
+
+my $pid = launch_with_config($config);
+
+#####################################################################
+# Open a floating window, verifying that its initial position is
+# centered, and also verify that both centering methods leave it in
+# its original spot.
+#####################################################################
+
+my $first = open_floating_window;
+
+my $initial = $first->rect;
+is(int($initial->{x} + $initial->{width} / 2), int($x->root->rect->width / 2),
+   'x coordinates match');
+is(int($initial->{y} + $initial->{height} / 2), int($x->root->rect->height / 2),
+   'y coordinates match');
+
+cmd 'move position center';
+
+my $new = $first->rect;
+is($initial->{x}, $new->{x}, 'x coordinates match');
+is($initial->{y}, $new->{y}, 'y coordinates match');
+
+cmd 'move absolute position center';
+
+$new = $first->rect;
+is($initial->{x}, $new->{x}, 'x coordinates match');
+is($initial->{y}, $new->{y}, 'y coordinates match');
+
+#####################################################################
+# Create a second window and move it into and out of the scratchpad.
+# Because it hasn't been moved or resized, it should be floated in
+# the center of the screen when pulled out of the scratchpad.
+#####################################################################
+
+my $second = open_window;
+
+cmd 'move scratchpad, scratchpad show';
+
+$new = $second->rect;
+my $mid_init = $initial->{x} + int($initial->{width} / 2);
+my $mid_new = $new->{x} + int($new->{width} / 2);
+is($mid_init, $mid_new, 'x midpoint is ws center');
+
+$mid_init = $initial->{y} + int($initial->{height} / 2);
+$mid_new = $new->{y} + int($new->{height} / 2);
+is($mid_init, $mid_new, 'y midpoint is ws center');
+
+#####################################################################
+# Verify that manually floating a tiled window results in proper
+# centering.
+#####################################################################
+
+my $third = open_window;
+
+cmd 'floating enable';
+
+$new = $third->rect;
+is($initial->{x}, $new->{x}, 'x coordinates match');
+is($initial->{y}, $new->{y}, 'y coordinates match');
+
+#####################################################################
+# Create a child window of the previous window, which should result
+# in the new window being centered over the last one.
+#####################################################################
+
+my $fourth = open_window( dont_map => 1, client_leader => $third );
+$fourth->map;
+sync_with_i3;
+
+my $child = $fourth->rect;
+is($new->{x}, $child->{x}, 'x coordinates match');
+is($new->{y}, $child->{y}, 'y coordinates match');
+
+exit_gracefully($pid);
+
+done_testing;
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/testcases/t/242-no-focus.t ./testcases/t/242-no-focus.t
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/testcases/t/242-no-focus.t	1969-12-31 18:00:00.000000000 -0600
+++ ./testcases/t/242-no-focus.t	2015-06-20 00:55:28.000000000 -0500
@@ -0,0 +1,66 @@
+#!perl
+# vim:ts=4:sw=4:expandtab
+#
+# Please read the following documents before working on tests:
+# • http://build.i3wm.org/docs/testsuite.html
+#   (or docs/testsuite)
+#
+# • http://build.i3wm.org/docs/lib-i3test.html
+#   (alternatively: perldoc ./testcases/lib/i3test.pm)
+#
+# • http://build.i3wm.org/docs/ipc.html
+#   (or docs/ipc)
+#
+# • http://onyxneon.com/books/modern_perl/modern_perl_a4.pdf
+#   (unless you are already familiar with Perl)
+#
+# Test the 'no_focus' directive.
+# Ticket: #1416
+use i3test i3_autostart => 0;
+
+#####################################################################
+# 1: open a window and check that it takes focus
+#####################################################################
+
+my $config = <<EOT;
+# i3 config file (v4)
+font -misc-fixed-medium-r-normal--13-120-75-75-C-70-iso10646-1
+EOT
+
+my $pid = launch_with_config($config);
+ 
+my $ws = fresh_workspace;
+my $first = open_window;
+my $focused = get_focused($ws);
+my $second = open_window;
+
+isnt(get_focused($ws), $focused, 'focus has changed');
+
+exit_gracefully($pid);
+
+#####################################################################
+# 2: open a window matched by a no_focus directive and check that
+#    it doesn't take focus
+#####################################################################
+
+my $config = <<EOT;
+# i3 config file (v4)
+font -misc-fixed-medium-r-normal--13-120-75-75-C-70-iso10646-1
+
+no_focus [instance=notme]
+EOT
+
+my $pid = launch_with_config($config);
+ 
+my $ws = fresh_workspace;
+my $first = open_window;
+my $focused = get_focused($ws);
+my $second = open_window(wm_class => 'notme');
+
+is(get_focused($ws), $focused, 'focus has not changed');
+
+exit_gracefully($pid);
+
+#####################################################################
+
+done_testing;
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/testcases/t/523-move-position-center.t ./testcases/t/523-move-position-center.t
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/testcases/t/523-move-position-center.t	1969-12-31 18:00:00.000000000 -0600
+++ ./testcases/t/523-move-position-center.t	2015-06-20 00:55:28.000000000 -0500
@@ -0,0 +1,63 @@
+#!perl
+# vim:ts=4:sw=4:expandtab
+#
+# Please read the following documents before working on tests:
+# • http://build.i3wm.org/docs/testsuite.html
+#   (or docs/testsuite)
+#
+# • http://build.i3wm.org/docs/lib-i3test.html
+#   (alternatively: perldoc ./testcases/lib/i3test.pm)
+#
+# • http://build.i3wm.org/docs/ipc.html
+#   (or docs/ipc)
+#
+# • http://onyxneon.com/books/modern_perl/modern_perl_a4.pdf
+#   (unless you are already familiar with Perl)
+#
+# Verifies that 'move position center' moves floating cons to the center of
+# the appropriate output.
+# Ticket: #1211
+# Bug still in: 4.9.1-108-g037cb31
+use i3test i3_autostart => 0;
+
+my $config = <<EOT;
+# i3 config file (v4)
+font -misc-fixed-medium-r-normal--13-120-75-75-C-70-iso10646-1
+
+fake-outputs 1024x768+0+0,1024x768+1024+0
+
+workspace left output fake-0
+workspace right output fake-1
+EOT
+
+my $pid = launch_with_config($config);
+
+#####################################################################
+# Verify that 'move position center' on a floating window does not
+# move it to another output.
+#####################################################################
+
+cmd 'workspace left';
+
+# Sync in case focus switched outputs due to the workspace change.
+sync_with_i3;
+
+my $floating = open_floating_window;
+
+# Center the window on the left workspace
+cmd 'move position center';
+sync_with_i3;
+
+is(scalar @{get_ws('left')->{floating_nodes}}, 1, 'one floating node on left ws');
+is(scalar @{get_ws('right')->{floating_nodes}}, 0, 'no floating nodes on right ws');
+
+# Center the window on the right workspace
+cmd 'move workspace right; workspace right; move position center';
+sync_with_i3;
+
+is(scalar @{get_ws('left')->{floating_nodes}}, 0, 'no floating nodes on left ws');
+is(scalar @{get_ws('right')->{floating_nodes}}, 1, 'one floating node on right ws');
+
+exit_gracefully($pid);
+
+done_testing;
diff -N -r -u /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/testcases/t/524-move.t ./testcases/t/524-move.t
--- /home/tony/work/i3-gaps-freebsd/work/i3-4.10.2/testcases/t/524-move.t	1969-12-31 18:00:00.000000000 -0600
+++ ./testcases/t/524-move.t	2015-06-20 00:55:28.000000000 -0500
@@ -0,0 +1,99 @@
+#!perl
+# vim:ts=4:sw=4:expandtab
+#
+# Please read the following documents before working on tests:
+# • http://build.i3wm.org/docs/testsuite.html
+#   (or docs/testsuite)
+#
+# • http://build.i3wm.org/docs/lib-i3test.html
+#   (alternatively: perldoc ./testcases/lib/i3test.pm)
+#
+# • http://build.i3wm.org/docs/ipc.html
+#   (or docs/ipc)
+#
+# • http://onyxneon.com/books/modern_perl/modern_perl_a4.pdf
+#   (unless you are already familiar with Perl)
+#
+# Tests the behaviour of 'move <direction>' when moving containers across
+# outputs on workspaces that have non-default layouts.
+# Ticket: #1603
+# Bug still in: 4.10.1-40-g0ad097e
+use List::Util qw(first);
+use i3test i3_autostart => 0;
+
+my $config = <<EOT;
+# i3 config file (v4)
+font -misc-fixed-medium-r-normal--13-120-75-75-C-70-iso10646-1
+
+fake-outputs 1024x768+0+0,1024x768+1024+0,1024x768+1024+768,1024x768+0+768
+
+workspace left-top output fake-0
+workspace right-top output fake-1
+workspace right-bottom output fake-2
+workspace left-bottom output fake-3
+
+workspace_layout stacked
+EOT
+
+my $pid = launch_with_config($config);
+
+#####################################################################
+# Create two windows in the upper left workspace and move them
+# clockwise around the workspaces until the end up where they began.
+#####################################################################
+
+cmd 'workspace left-top';
+
+my $first = open_window(wm_class => 'first');
+my $second = open_window(wm_class => 'second');
+
+is_num_children('left-top', 1, 'one child on left-top');
+is_num_children('right-top', 0, 'no children on right-top');
+
+# Move the second window into its own stacked container.
+cmd 'move right';
+is_num_children('left-top', 2, 'two children on left-top');
+
+# Move the second window onto the upper right workspace.
+cmd 'move right';
+is_num_children('left-top', 1, 'one child on left-top');
+is_num_children('right-top', 1, 'one child on right-top');
+
+# Move the first window onto the upper right workspace.
+cmd '[class="first"] move right';
+is_num_children('left-top', 0, 'no children on left-top');
+is_num_children('right-top', 2, 'two children on right-top');
+
+# Move the second window onto the lower right workspace.
+cmd '[class="second"] move down, move down';
+is_num_children('right-top', 1, 'one child on right-top');
+is_num_children('right-bottom', 1, 'two children on right-bottom');
+
+# Move the first window onto the lower right workspace.
+cmd '[class="first"] move down';
+is_num_children('right-top', 0, 'no children on right-top');
+is_num_children('right-bottom', 2, 'two children on right-bottom');
+
+# Move the second windo onto the lower left workspace.
+cmd '[class="second"] move left, move left';
+is_num_children('right-bottom', 1, 'one child on right-bottom');
+is_num_children('left-bottom', 1, 'one on left-bottom');
+
+# Move the first window onto the lower left workspace.
+cmd '[class="first"] move left';
+is_num_children('right-bottom', 0, 'no children on right-bottom');
+is_num_children('left-bottom', 2, 'two children on left-bottom');
+
+# Move the second window onto the upper left workspace.
+cmd '[class="second"] move up, move up';
+is_num_children('left-bottom', 1, 'one child on left-bottom');
+is_num_children('left-top', 1, 'one child on left-top');
+
+# Move the first window onto the upper left workspace.
+cmd '[class="first"] move up';
+is_num_children('left-bottom', 0, 'no children on left-bottom');
+is_num_children('left-top', 2, 'two children on left-top');
+
+exit_gracefully($pid);
+
+done_testing;
